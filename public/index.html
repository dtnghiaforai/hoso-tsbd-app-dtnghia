<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Soáº¡n Há»“ sÆ¡ TSBÄ â€” Compact</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">
<style>
Â  html{font-family:'Lora',serif}
Â  .classic{transition:.15s;box-shadow:0 4px 0 rgba(0,0,0,.4);border-bottom:2px solid rgba(0,0,0,.4)}
Â  .tabbtn{border-radius:8px 8px 0 0;border:2px solid transparent}
Â  .table-input{width:100%;padding:.5rem;border:1px solid #d1d5db;border-radius:4px; transition: background-color 0.1s;}
Â  .stt{min-height:2.5rem;display:flex;align-items:center;justify-content:center}
</style>
</head>
<body class="bg-stone-100 p-4 md:p-10 text-gray-800">
<div class="mx-auto max-w-6xl bg-amber-50 p-6 md:p-10 rounded-xl shadow-2xl border-4 border-amber-800/80">
Â  <h1 class="text-3xl font-bold text-amber-900 mb-4 text-center tracking-wider border-b-2 border-amber-700 pb-3">ğŸ“ á»¨ng dá»¥ng Soáº¡n tháº£o Há»“ sÆ¡ TÃ i sáº£n Báº£o Ä‘áº£m</h1>
Â  <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-lg">
Â  Â  <b>âš ï¸ ChÃº Ã½:</b> Táº¡o .docx cáº§n backend. á»¨ng dá»¥ng nÃ y Ä‘Ã£ tÃ­ch há»£p sáºµn backend.
Â  </div>
Â  <div class="flex flex-wrap justify-center gap-4 mb-6">
Â  Â  <input id="templateFile" type="file" accept=".docx" hidden>
Â  Â  <button onclick="$('#templateFile').click()" class="py-2 px-4 bg-amber-800 text-white rounded-lg classic">ğŸ“‚ Chá»n template</button>
Â  Â  <span id="templateFileName" class="self-center italic text-amber-900">ChÆ°a chá»n file</span>
Â  Â  <button id="btn-save" onclick="saveData()" class="py-2 px-4 bg-yellow-700 text-amber-900 rounded-lg classic">ğŸ’¾ LÆ°u nhÃ¡p (JSON)</button>
Â  Â  <input id="loadFileInput" type="file" accept=".json" hidden>
Â  Â  <button onclick="$('#loadFileInput').click()" class="py-2 px-4 bg-yellow-700 text-amber-900 rounded-lg classic">ğŸ“¥ Táº£i dá»¯ liá»‡u</button>
Â  </div>

Â  <div id="tabMenu" class="flex flex-wrap gap-2 mb-4"></div>
Â  <form id="profileForm">
Â  Â  <div id="tabContent" class="p-6 border-2 border-amber-700 bg-white rounded-b-xl rounded-tr-xl shadow-inner"></div>
Â  Â  <div class="text-center mt-8"><button id="btn-generate" class="py-3 px-8 bg-green-700 text-white rounded-lg classic">âœï¸ Táº¡o & Táº£i DOCX</button></div>
Â  </form>
Â  <div id="message" class="hidden mt-4 p-3 rounded-lg font-bold text-center"></div>
</div>

<script>
// \u00B2 lÃ  kÃ½ tá»± m^2
const BASE_DAT=[
Â  {id:"ten_tsbd$X$",label:"TÃªn tÃ i sáº£n báº£o Ä‘áº£m (TSBÄ) $X$",type:"text"},
Â  {id:"hoso_tsbd$X$",label:"Há»“ sÆ¡ TSBÄ $X$",type:"textarea"},
Â  {id:"sothuadat_tsbd$X$",label:"Sá»‘ Thá»­a Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"tobando_tsbd$X$",label:"Sá»‘ Tá» báº£n Ä‘á»“ TSBÄ $X$",type:"text"},
Â  {id:"dientichdat_tsbd$X$",label:"Diá»‡n tÃ­ch Ä‘áº¥t TSBÄ $X$ (m\u00B2)",type:"text"},
Â  {id:"dientichdatbangchu_tsbd$X$",label:"Diá»‡n tÃ­ch Ä‘áº¥t TSBÄ $X$ (báº±ng chá»¯)",type:"text"},
Â  {id:"loaidat_tsbd$X$",label:"Loáº¡i Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"thoihansudungdat_tsbd$X$",label:"Thá»i háº¡n sá»­ dá»¥ng Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"hinhthucsudungdat_tsbd$X$",label:"HÃ¬nh thá»©c sá»­ dá»¥ng Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"diachi_tsbd$X$",label:"Äá»‹a chá»‰ TSBÄ $X$",type:"text"},
Â  {id:"nguongoc_tsbd$X$",label:"Nguá»“n gá»‘c sá»­ dá»¥ng Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"ghichu_tsbd$X$",label:"Ghi chÃº TSBÄ $X$",type:"textarea"},
Â  {id:"vitridat_tsbd$X$",label:"Vá»‹ trÃ­ Ä‘áº¥t TSBÄ $X$ theo Khung giÃ¡ UBND",type:"text"},
Â  {id:"sodothuadat_tsbd$X$",label:"SÆ¡ Ä‘á»“ thá»­a Ä‘áº¥t TSBÄ $X$",type:"textarea"},
Â  {id:"thongtinquyhoach_tsbd$X$",label:"ThÃ´ng tin quy hoáº¡ch TSBÄ $X$",type:"text"},
Â  {id:"thongtintranhchap_tsbd$X$",label:"ThÃ´ng tin tranh cháº¥p TSBÄ $X$",type:"text"},
Â  {id:"hanche_tsbd$X$",label:"Háº¡n cháº¿ cá»§a TSBÄ $X$",type:"text"},
Â  {id:"hientrangkhac_tsbd$X$",label:"Hiá»‡n tráº¡ng khÃ¡c cá»§a TSBÄ $X$",type:"textarea"},
Â  {id:"noidungkhongphuhopphaply_tsbd$X$",label:"Ná»™i dung khÃ´ng phÃ¹ há»£p vá»›i há»“ sÆ¡ phÃ¡p lÃ½ TSBÄ $X$",type:"text"},
Â  {id:"phantichvitri_tsbd$X$",label:"PhÃ¢n tÃ­ch vá»‹ trÃ­ TSBÄ $X$",type:"textarea"},
Â  {id:"phantichsudung_tsbd$X$",label:"PhÃ¢n tÃ­ch tÃ¬nh hÃ¬nh sá»­ dá»¥ng TSBÄ $X$",type:"textarea"}
];
// ÄÃ£ thÃªm (mÂ²) vÃ o nhÃ£n (label)
const BASE_NHA=[
Â  {id:"loainhao_tsbd$X$",label:"Loáº¡i NhÃ  á»Ÿ TSBÄ $X$",type:"text"},
Â  {id:"dientichxd_tsbd$X$",label:"Diá»‡n tÃ­ch xÃ¢y dá»±ng TSBÄ $X$ (m\u00B2)",type:"text"},
Â  {id:"dientichsan_tsbd$X$",label:"Diá»‡n tÃ­ch sÃ n TSBÄ $X$ (m\u00B2)",type:"text"},
Â  {id:"hinhthucsohuu_tsbd$X$",label:"HÃ¬nh thá»©c sá»Ÿ há»¯u TSBÄ $X$",type:"text"},
Â  {id:"capnhao_tsbd$X$",label:"Cáº¥p (Háº¡ng) cÃ´ng trÃ¬nh TSBÄ $X$",type:"text"},
Â  {id:"thoihansohuu_tsbd$X$",label:"Thá»i háº¡n sá»Ÿ há»¯u nhÃ  á»Ÿ TSBÄ $X$",type:"text"}
];
function genTSBD(base,i){return base.map(f=>{const id=f.id.replace('$X$',i);return {id, label:f.label.replace('$X$',i), type:f.type, genericId:id.replace(`_tsbd${i}`,'')}})}

const LAND_PRICE_FIELDS=[
Â  {id:"stt_bangkg",label:"TT",type:"text",width:"w-[5%]"},
Â  {id:"loaidat_bangkg",label:"Loáº¡i Ä‘áº¥t",type:"text",width:"w-[10%]",placeholder:"VD: Äáº¥t á»Ÿ"},
Â  {id:"tenduongpho_bangkg",label:"TÃªn Ä‘Æ°á»ng phá»‘",type:"text",width:"w-[20%]"},
Â  {id:"doanduong_bangkg",label:"Äoáº¡n Ä‘Æ°á»ng (Tá»« - Äáº¿n)",type:"text",width:"w-[15%]"},
Â  {id:"dgdatvt1_bangkg",label:"ÄÆ¡n giÃ¡ VT1 (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12.5%]"},
Â  {id:"dgdatvt2_bangkg",label:"ÄÆ¡n giÃ¡ VT2 (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12.5%]"},
Â  {id:"dgdatvt3_bangkg",label:"ÄÆ¡n giÃ¡ VT3 (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12.5%]"},
Â  {id:"dgdatvt4_bangkg",label:"ÄÆ¡n giÃ¡ VT4 (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12.5%]"}
];
const LAND_VALUE_FIELDS=[
Â  {id:"stt_bangdgts",label:"TT",type:"text",width:"w-[4%]"},
Â  {id:"gcnts_bangdgts",label:"Giáº¥y chá»©ng nháº­n tÃ i sáº£n",type:"text",width:"w-[12%]"},
Â  {id:"sothuadat_bangdgts",label:"Sá»‘ thá»­a Ä‘áº¥t",type:"text",width:"w-[8%]"},
Â  {id:"hangmuc_bangdgts",label:"Háº¡ng má»¥c",type:"text",width:"w-[12%]"},
Â  {id:"dientich_bangdgts",label:"Diá»‡n tÃ­ch (m\u00B2)",type:"currency-decimal-table",width:"w-[8%]"},
Â  {id:"dongia_bangdgts",label:"ÄÆ¡n giÃ¡ (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12%]"},
Â  {id:"clcl_bangdgts",label:"CLCL",type:"percent-integer-table",width:"w-[6%]"},
Â  {id:"thanhtien_bangdgts",label:"ThÃ nh tiá»n (Ä‘á»“ng)",type:"currency-integer-table",width:"w-[12%]",readonly:true},
Â  {id:"thanhtienlamtron_bangdgts",label:"ThÃ nh tiá»n lÃ m trÃ²n (Ä‘á»“ng)",type:"currency-integer-table",width:"w-[12%]",readonly:true},
Â  {id:"mucctdtoida_bangdgts",label:"Má»©c cáº¥p tÃ­n dá»¥ng tá»‘i Ä‘a (Ä‘á»“ng)",type:"currency-integer-table",width:"w-[12%]"},
Â  {id:"tyleboa_bangdgts",label:"Tá»· lá»‡ BOA",type:"percent-decimal-table",width:"w-[6%]",readonly:true},
Â  {id:"cancudinhgia_bangdgts",label:"CÄƒn cá»© Ä‘á»‹nh giÃ¡",type:"text",width:"w-[10%]"}
];

const LAND_PRICE_TABLE_CONFIG = {isTable:true,dataKey:'bang_khung_gia_dat',fields:LAND_PRICE_FIELDS};
const MERGED_LAND_PRICE_TAB_ID = '10-KhungGiaDat';

// FIELDS: Tab 1 bá» tonggiatri, Tab 4, 6, 8 hiá»ƒn thá»‹ tÃªn trÆ°á»ng PhÃ¢n tÃ­ch vá»‹ trÃ­ TSBÄ X
const FIELDS={
Â  "1. ThÃ´ng tin chung":[{id:"tieude_bbdg",label:"TiÃªu Ä‘á» biÃªn báº£n Ä‘á»‹nh giÃ¡",type:"select",options:["Äá»‹nh giÃ¡ tÃ i sáº£n báº£o Ä‘áº£m","Äá»‹nh giÃ¡ láº¡i tÃ i sáº£n báº£o Ä‘áº£m"]},{id:"so_bbdg",label:"Sá»‘ biÃªn báº£n",type:"text"},{id:"ngay_bbdg",label:"NgÃ y láº­p (dd/mm/yyyy)",type:"text"},{id:"thoigian_bbdg",label:"Thá»i gian láº­p (hh:mm)",type:"text"},{id:"noilap_bbdg",label:"NÆ¡i láº­p",type:"text"},{id:"thoigian_khaosattsbd",label:"Thá»i gian kháº£o sÃ¡t (hh:mm)",type:"text"},{id:"ngay_khaosattsbd",label:"NgÃ y kháº£o sÃ¡t (dd/mm/yyyy)",type:"text"}],
Â  "2. BÃªn nháº­n báº£o Ä‘áº£m":[{id:"bnbd",label:"TÃªn BÃªn Nháº­n Báº£o Äáº£m",type:"text"},{id:"gcndk_bnbd",label:"GCN Ä‘Äƒng kÃ½ doanh nghiá»‡p",type:"text"},{id:"diachi_bnbd",label:"Äá»‹a chá»‰",type:"text"}],
Â  "3. BÃªn báº£o Ä‘áº£m":[{id:"ten_bbd1",label:"TÃªn BBÄ 1",type:"text"},{id:"gttt_bbd1",label:"Giáº¥y tá» BBÄ 1",type:"text"},{id:"diachi_bbd1",label:"Äá»‹a chá»‰ BBÄ 1",type:"text"},{id:"ten_bbd2",label:"TÃªn BBÄ 2",type:"text"},{id:"gttt_bbd2",label:"Giáº¥y tá» BBÄ 2",type:"text"},{id:"diachi_bbd2",label:"Äá»‹a chá»‰ BBÄ 2",type:"text"}],
Â  "4. TÃ i sáº£n báº£o Ä‘áº£m 1 (Thá»­a Ä‘áº¥t)":genTSBD(BASE_DAT,1),
Â  "5. TÃ i sáº£n báº£o Ä‘áº£m 1 (NhÃ  á»Ÿ)":genTSBD(BASE_NHA,1),
Â  "6. TÃ i sáº£n báº£o Ä‘áº£m 2 (Thá»­a Ä‘áº¥t)":genTSBD(BASE_DAT,2),
Â  "7. TÃ i sáº£n báº£o Ä‘áº£m 2 (NhÃ  á»Ÿ)":genTSBD(BASE_NHA,2),
Â  "8. TÃ i sáº£n báº£o Ä‘áº£m 3 (Thá»­a Ä‘áº¥t)":genTSBD(BASE_DAT,3),
Â  "9. TÃ i sáº£n báº£o Ä‘áº£m 3 (NhÃ  á»Ÿ)":genTSBD(BASE_NHA,3),
Â  "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡":[{id:"cancudg",label:"CÄƒn cá»© Ä‘á»‹nh giÃ¡",type:"textarea"}],
Â  "11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡":{isTable:true,dataKey:'bang_giatri_dinhgia',fields:LAND_VALUE_FIELDS},
Â  // *** START CHANGE ***
Â  "12. Há»£p Ä‘á»“ng báº£o Ä‘áº£m": [
Â  Â  {id:"ten_hdbd", label:"TÃªn Há»£p Ä‘á»“ng báº£o Ä‘áº£m", type:"text"},
Â  Â  {id:"so_hdbd", label:"Sá»‘ Há»£p Ä‘á»“ng báº£o Ä‘áº£m", type:"text"},
Â  Â  {id:"ten_benvay1", label:"TÃªn BÃªn Vay 1", type:"text"},
Â  Â  {id:"gttt_benvay1", label:"GTTT BÃªn Vay 1", type:"text"},
Â  Â  {id:"diachi_benvay1", label:"Äá»‹a chá»‰ BÃªn Vay 1", type:"text"},
Â  Â  {id:"ten_benvay2", label:"TÃªn BÃªn Vay 2", type:"text"},
Â  Â  {id:"gttt_benvay2", label:"GTTT BÃªn Vay 2", type:"text"},
Â  Â  {id:"diachi_benvay2", label:"Äá»‹a chá»‰ BÃªn Vay 2", type:"text"},
Â  Â  {id:"bpbdtheopd", label:"Biá»‡n phÃ¡p báº£o Ä‘áº£m theo phÃª duyá»‡t", type:"text"}
Â  ]
Â  // *** END CHANGE ***
};
let copied={dat:null,nha:null},rowIdx=0;
const $=(s)=>document.querySelector(s);

function show(msg, type='info') {
Â  const d = $('#message');
Â  d.textContent = msg;
Â  d.className = 'mt-4 p-3 rounded-lg font-bold text-center';
Â  if (type === 'success') {
Â  Â  d.classList.add('bg-green-100', 'text-green-800');
Â  } else if (type === 'error') {
Â  Â  d.classList.add('bg-red-100', 'text-red-800');
Â  } else {
Â  Â  d.classList.add('bg-amber-100', 'text-amber-900');
Â  }
Â  d.classList.remove('hidden');
Â  setTimeout(() => d.classList.add('hidden'), 5000);
}

function numFmt(s){if(!s) return '';const d=String(s).replace(/\D/g,'');return d.replace(/\B(?=(\d{3})+(?!\d))/g,'.')}
function numFmtDecimal(s){if(!s) return '';let cleaned=String(s).replace(/[^\d,]/g,'');const parts=cleaned.split(',');if(parts.length>2) cleaned=parts[0]+','+parts.slice(1).join('');if(parts.length===2){return parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.')+','+parts[1]}return cleaned.replace(/\B(?=(\d{3})+(?!\d))/g,'.')}
function parseVN(str){if(!str) return 0;const cleaned=String(str).replace(/\./g,'').replace(/,/g,'.').replace(/[^0-9\.]/g,'');const n=parseFloat(cleaned);return isNaN(n)?0:n}
function readG(s){const u=['','má»™t','hai','ba','bá»‘n','nÄƒm','sÃ¡u','báº£y','tÃ¡m','chÃ­n'];if(!s) return '';s=('000'+s).slice(-3);const d1=+s[0],d2=+s[1],d3=+s[2];let r='';if(d1) r+=u[d1]+' trÄƒm';if(d2) r+=(r?' ':'')+(d2==1?'mÆ°á»i':u[d2]+' mÆ°Æ¡i');else if(d1 && d3) r+=(r?' ':'')+'láº»';if(d3) {r+=(r?' ':'');if(d2==1) r+= (d3==5?'lÄƒm':u[d3]); else if(d2>=2) r+=(d3==1?'má»‘t':(d3==5?'lÄƒm':u[d3])); else r+=u[d3]}return r.trim()}
function toWords(raw){let s=String(raw).replace(/\D/g,'');if(!s||s=='0') return 'KhÃ´ng Ä‘á»“ng';s=s.replace(/^0+/,'');const g=[];let t=s;while(t.length){const gl=t.length>3?3:t.length;g.unshift(t.slice(-gl));t=t.slice(0,-gl)};let out='';for(let i=0;i<g.length;i++){const gw=readG(g[i]);const idx=g.length-1-i;let u='';if(idx==1) u='nghÃ¬n';else if(idx==2) u='triá»‡u';else if(idx==3) u='tá»·';else if(idx==4) u='nghÃ¬n tá»·';if(gw){out+=(out?' ':'')+gw+(u?' '+u:'')}}out=out.replace(/tá»· triá»‡u/g,'tá»·').trim();return out.charAt(0).toUpperCase()+out.slice(1)+' Ä‘á»“ng'}

function openTab(evt, tabName){
Â  const contents=document.getElementsByClassName('tab-content');
Â  for(let i=0;i<contents.length;i++) contents[i].style.display='none';
Â  const buttons=document.getElementById('tabMenu').getElementsByTagName('button');
Â  for(let i=0;i<buttons.length;i++){
Â  Â  buttons[i].className='py-2 px-4 text-sm font-semibold bg-stone-200 border-2 text-amber-900 tabbtn';
Â  }
Â  const current=document.getElementById(tabName);
Â  if(current) current.style.display='block';
Â  if(evt && evt.currentTarget) evt.currentTarget.className='py-2 px-4 text-sm font-semibold bg-white border-2 border-amber-700 text-amber-900 tabbtn';
Â  else if(buttons.length>0) buttons[0].className='py-2 px-4 text-sm font-semibold bg-white border-2 border-amber-700 text-amber-900 tabbtn';
}
function createField(f){
Â  const wr=document.createElement('div');
Â  wr.className='form-group mb-4';
Â  const lab=document.createElement('label');
Â  lab.htmlFor=f.id;
Â  lab.className='block mb-2 font-bold text-gray-700';
Â  lab.textContent=f.label+' (ID: '+f.id+'): ';
Â  wr.appendChild(lab);
Â  let inp;
Â  if(f.type==='textarea'){
Â  Â  inp=document.createElement('textarea');
Â  Â  inp.rows=3;
Â  Â  inp.className='w-full p-2 border-2 rounded-md';
Â  }else if(f.type==='select'){
Â  Â  inp=document.createElement('select');
Â  Â  inp.className='w-full p-2 border-2 rounded-md';
Â  Â  f.options.forEach(o=>{
Â  Â  Â  const op=document.createElement('option');
Â  Â  Â  op.value=o;
Â  Â  Â  op.textContent=o;
Â  Â  Â  inp.appendChild(op);
Â  Â  });
Â  }else{
Â  Â  inp=document.createElement('input');
Â  Â  inp.type='text';
Â  Â  inp.className='w-full p-2 border-2 rounded-md';
Â  }
Â  inp.id=f.id;
Â  inp.name=f.id;
Â  wr.appendChild(inp);
Â  return wr;
}
function getTableConfig(tabName) {
Â  if (tabName === MERGED_LAND_PRICE_TAB_ID) return LAND_PRICE_TABLE_CONFIG;
Â  const cfg = FIELDS[tabName];
Â  if (cfg && cfg.isTable) return cfg;
Â  return null;
}
function createTotalSummaryContainer(tabName,cfg){
Â  const cont=document.createElement('div');
Â  cont.className='mt-8 pt-6 border-t-2 border-amber-700 space-y-4';

Â  // Pháº§n tá»•ng há»£p (Di chuyá»ƒn tá»« Tab 1)
Â  cont.innerHTML=`
Â  Â  <h3 class="text-xl font-bold text-amber-900 mb-3">Káº¿t quáº£ Ä‘á»‹nh giÃ¡ TÃ i sáº£n Báº£o Ä‘áº£m</h3>
Â  Â  <div class="space-y-4 p-4 border rounded-lg bg-yellow-50 shadow-inner">
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="tonggiatri_tsbd_bangso" class="block mb-2 font-bold text-gray-700">Tá»•ng giÃ¡ trá»‹ cÃ¡c tÃ i sáº£n báº£o Ä‘áº£m (báº±ng sá»‘) (Ä‘á»“ng) (ID: tonggiatri_tsbd_bangso):</label>
Â  Â  Â  Â  <div class="flex gap-2 items-center">
Â  Â  Â  Â  Â  <input type="text" id="tonggiatri_tsbd_bangso" name="tonggiatri_tsbd_bangso" readonly class="w-full p-2 border-2 rounded-md bg-stone-100 font-bold text-lg text-left">
Â  Â  Â  Â  Â  <button type="button" onclick="updateTotalRow()" class="flex-shrink-0 py-2 px-4 bg-amber-600 text-white rounded-lg classic text-sm whitespace-nowrap hover:bg-amber-700">TÃ­nh tá»•ng</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="tonggiatri_tsbd_bangchu" class="block mb-2 font-bold text-gray-700">Tá»•ng giÃ¡ trá»‹ cÃ¡c tÃ i sáº£n báº£o Ä‘áº£m (báº±ng chá»¯) (ID: tonggiatri_tsbd_bangchu):</label>
Â  Â  Â  Â  <textarea id="tonggiatri_tsbd_bangchu" name="tonggiatri_tsbd_bangchu" rows="2" readonly class="w-full p-2 border-2 rounded-md bg-stone-100 font-bold"></textarea>
Â  Â  Â  </div>
Â  Â  </div>
Â  `;
Â  return cont;
}

function renderTable(name,conf){
Â  const cont=document.createElement('div');
Â  cont.id=name;
Â  cont.className='tab-content';
Â  cont.style.display='none';
Â  const wrap=document.createElement('div');
Â  wrap.className='overflow-x-auto';
Â  const table=document.createElement('table');
Â  table.className='w-full divide-y border rounded-lg';
Â  const thead=document.createElement('thead');
Â  thead.className='bg-amber-100 sticky top-0';
Â  const hr=document.createElement('tr');
Â  conf.fields.forEach(f=>{
Â  Â  const th=document.createElement('th');
Â  Â  th.className='p-3 text-left text-xs font-semibold '+(f.width||'');
Â  Â  th.textContent=f.label;
Â  Â  hr.appendChild(th);
Â  });
Â  const act=document.createElement('th');
Â  act.className='p-3 text-center w-[50px]';
Â  act.textContent='XoÃ¡';
Â  hr.appendChild(act);
Â  thead.appendChild(hr);
Â  table.appendChild(thead);
Â  const tbody=document.createElement('tbody');
Â  tbody.className='bg-white table-body';
Â  table.appendChild(tbody);
Â Â 
Â  // ThÃªm dÃ²ng Tá»”NG Cá»˜NG vÃ o footer náº¿u lÃ  tab 11
Â  if (name === '11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') {
Â  Â  const tfoot=document.createElement('tfoot');
Â  Â  tfoot.className='bg-amber-200 font-bold border-t-2 border-amber-800';
Â  Â  tfoot.innerHTML=`
Â  Â  Â  <tr class="font-bold">
Â  Â  Â  Â  <td class="p-2 text-center border-r" colspan="6">Tá»”NG Cá»˜NG</td>
Â  Â  Â  Â  <td class="p-1 border-r text-center"></td>
Â  Â  Â  Â  <td class="p-1 border-r"><input type="text" id="tong_thanhtien_bangdgts" name="tong_thanhtien_bangdgts" readonly class="table-input text-sm bg-transparent border-none text-right font-bold p-1"></td>
Â  Â  Â  Â  <td class="p-1 border-r"><input type="text" id="tong_thanhtienlamtron_bangdgts" name="tong_thanhtienlamtron_bangdgts" readonly class="table-input text-sm bg-transparent border-none text-right font-bold p-1"></td>
Â  Â  Â  Â  <td class="p-1 border-r"><input type="text" id="tong_mucctdtoida_bangdgts" name="tong_mucctdtoida_bangdgts" readonly class="table-input text-sm bg-transparent border-none text-right font-bold p-1"></td>
Â  Â  Â  Â  <td class="p-1 border-r"><input type="text" id="tong_tyleBOA_bangdgts" name="tong_tyleBOA_bangdgts" readonly class="table-input text-sm bg-transparent border-none text-right font-bold p-1"></td>
Â  Â  Â  Â  <td class="p-2 text-center"></td>
Â  Â  Â  </tr>
Â  Â  `;
Â  Â  table.appendChild(tfoot);
Â  }
Â  wrap.appendChild(table);
Â  cont.appendChild(wrap);
Â Â 
Â  const btnC=document.createElement('div');
Â  btnC.className='mt-6 pt-4 border-t flex justify-end';
Â  const add=document.createElement('button');
Â  add.type='button';
Â  add.textContent='â• ThÃªm dÃ²ng má»›i';
Â  add.className='py-2 px-4 bg-amber-600 text-white rounded-lg classic';
Â  add.onclick=()=>addRow(name);
Â  btnC.appendChild(add);
Â  cont.appendChild(btnC);
Â Â 
Â  // ThÃªm pháº§n Tá»•ng há»£p giÃ¡ trá»‹ TSBÄ (di chuyá»ƒn tá»« Tab 1)
Â  if (name === '11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') {
Â  Â  cont.appendChild(createTotalSummaryContainer(name, conf));
Â  }
Â Â 
Â  setTimeout(()=>addRow(name,true),0);
Â  return cont;
}

function getTabInfo(n){
Â  const m=n.match(/TÃ i sáº£n báº£o Ä‘áº£m (\d) \((Thá»­a Ä‘áº¥t|NhÃ  á»Ÿ)\)/);
Â  if(!m) return null;
Â  return{index:+m[1],type:m[2]==='Thá»­a Ä‘áº¥t'?'dat':'nha',groupName:m[2]};
}

// HÃ m nÃ y khÃ´ng Ä‘á»•i, chá»‰ Ä‘áº£m báº£o nÃ³ Ä‘Æ°á»£c gá»i láº¡i khi cáº§n
function updateTotalRow(){
Â  const tab='11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡';
Â  const rows=document.querySelectorAll(`#${CSS.escape(tab)} .table-body tr`);
Â  let totalThanhTien=0;
Â  let totalThanhTienLamTron=0;
Â  let totalMucCTDToiDa=0;

Â  rows.forEach(r=>{
Â  Â  const ttEl=r.querySelector('input[name="thanhtien_bangdgts"]');
Â  Â  const ttltEl=r.querySelector('input[name="thanhtienlamtron_bangdgts"]');
Â  Â  const mctdEl=r.querySelector('input[name="mucctdtoida_bangdgts"]');

Â  Â  totalThanhTien+=parseVN(ttEl?.value);
Â  Â  totalThanhTienLamTron+=parseVN(ttltEl?.value);
Â  Â  totalMucCTDToiDa+=parseVN(mctdEl?.value);
Â  });

Â  const t_tt=$('#tong_thanhtien_bangdgts');
Â  const t_ttlt=$('#tong_thanhtienlamtron_bangdgts');
Â  const t_mctd=$('#tong_mucctdtoida_bangdgts');
Â  const t_boa=$('#tong_tyleBOA_bangdgts');
Â  const t_bangso=$('#tonggiatri_tsbd_bangso');
Â  const t_bangchu=$('#tonggiatri_tsbd_bangchu');

Â  // 1. Cáº­p nháº­t cÃ¡c trÆ°á»ng tá»•ng tiá»n trong tfoot
Â  if(t_tt)t_tt.value=totalThanhTien?numFmt(String(totalThanhTien)):'';
Â  if(t_ttlt)t_ttlt.value=totalThanhTienLamTron?numFmt(String(totalThanhTienLamTron)):'';
Â  if(t_mctd)t_mctd.value=totalMucCTDToiDa?numFmt(String(totalMucCTDToiDa)):'';

Â  // 2. TÃ­nh Tá»· lá»‡ BOA (Tá»•ng Má»©c CTD / Tá»•ng ThÃ nh tiá»n lÃ m trÃ²n)
Â  let totalBOA=0;
Â  if(totalThanhTienLamTron>0){
Â  Â  totalBOA=(totalMucCTDToiDa/totalThanhTienLamTron)*100;
Â  }
Â  if(t_boa)t_boa.value=isFinite(totalBOA)?(Math.round(totalBOA*100)/100).toFixed(2).replace('.',',')+' %':'';

Â  // 3. Cáº­p nháº­t Tá»•ng giÃ¡ trá»‹ TSBÄ (báº±ng sá»‘) = Tá»•ng ThÃ nh tiá»n lÃ m trÃ²n
Â  if(t_bangso){
Â  Â  // Sá»­ dá»¥ng giÃ¡ trá»‹ Ä‘Ã£ format Ä‘á»ƒ hiá»ƒn thá»‹
Â  Â  t_bangso.value=t_ttlt.value;Â 
Â  Â  // LÆ°u giÃ¡ trá»‹ thÃ´ Ä‘á»ƒ tÃ­nh toÃ¡n/lÆ°u file, máº·c dÃ¹ cÃ´ng thá»©c Ä‘Ã£ Ä‘Æ°á»£c tá»± Ä‘á»™ng hÃ³a.
Â  Â  t_bangso.setAttribute('data-raw',totalThanhTienLamTron);Â 
Â  }
Â  // 4. Cáº­p nháº­t Tá»•ng giÃ¡ trá»‹ TSBÄ (báº±ng chá»¯)
Â  if(t_bangchu)t_bangchu.value=toWords(totalThanhTienLamTron);
}

function attachRowCalc(row,cfg){
Â  const get=(n)=>row.querySelector(`input[name="${n}"]`);
Â  const a=get('dientich_bangdgts'),b=get('dongia_bangdgts'),c=get('clcl_bangdgts'),tt=get('thanhtien_bangdgts'),ttlt=get('thanhtienlamtron_bangdgts'),m=get('mucctdtoida_bangdgts'),ty=get('tyleboa_bangdgts');
Â  function compute(){
Â  Â  const dient=parseVN(a?.value),dong=parseVN(b?.value),cl=parseVN(c?.value)/100;
Â  Â  let thanhtien=Math.round(dient*dong*cl);
Â  Â  tt.value=thanhtien?numFmt(String(thanhtien)):'';
Â  Â  const lamtron=thanhtien?Math.floor(thanhtien/1e6)*1e6:0;
Â  Â  ttlt.value=lamtron?numFmt(String(lamtron)):'';
Â  Â  const muc=parseVN(m?.value);
Â  Â  let tyle=lamtron?((muc/lamtron)*100):0;
Â  Â  ty.value=isFinite(tyle)?(Math.round(tyle*100)/100).toFixed(2).replace('.',',')+' %':'';
Â  Â Â 
Â  Â  updateTotalRow(); // Gá»i hÃ m tÃ­nh tá»•ng sau khi cáº­p nháº­t má»™t dÃ²ng
Â  }
Â  [a,b,c,m].forEach(i=>{
Â  Â  if(i) i.addEventListener('input',()=>setTimeout(compute,0));
Â  Â  if(i) i.addEventListener('blur',()=>setTimeout(compute,0));
Â  });
Â  compute();
}

// ... CÃ¡c hÃ m khÃ¡c nhÆ° generateForm, addRow, updNums, collectData khÃ´ng thay Ä‘á»•i nhiá»u
function generateForm(){
Â  const menu=$('#tabMenu');
Â  const content=$('#tabContent');
Â  Object.keys(FIELDS).forEach((name,i)=>{
Â  Â  const cfg=FIELDS[name];
Â  Â  const btn=document.createElement('button');
Â  Â  btn.textContent=name;
Â  Â  btn.className='py-2 px-4 text-sm font-semibold bg-stone-200 border-2 text-amber-900 tabbtn';
Â  Â  btn.onclick=(e)=>openTab(e,name);
Â  Â  menu.appendChild(btn);
Â  Â  let node;
Â  Â  if(cfg.isTable){
Â  Â  Â  node=renderTable(name,cfg);
Â  Â  }else{
Â  Â  Â  node=document.createElement('div');
Â  Â  Â  node.id=name;
Â  Â  Â  node.className='tab-content';
Â  Â  Â  node.style.display='none';
Â  Â  Â  cfg.forEach(f=>node.appendChild(createField(f)));
Â  Â  Â Â 
Â  Â  Â  if (name === "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡") {
Â  Â  Â  Â  const tableNode = renderTable(MERGED_LAND_PRICE_TAB_ID, LAND_PRICE_TABLE_CONFIG);
Â  Â  Â  Â  tableNode.id = MERGED_LAND_PRICE_TAB_ID;
Â  Â  Â  Â  tableNode.style.display = 'block';
Â  Â  Â  Â  tableNode.classList.remove('tab-content');
Â  Â  Â  Â  const header = document.createElement('h2');
Â  Â  Â  Â  header.className = 'text-xl font-bold text-amber-900 mt-6 mb-3 border-b pb-2';
Â  Â  Â  Â  header.textContent = 'Báº£ng Khung giÃ¡ Ä‘áº¥t';
Â  Â  Â  Â  node.appendChild(header);
Â  Â  Â  Â  node.appendChild(tableNode);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const info=getTabInfo(name);
Â  Â  Â  if(info){
Â  Â  Â  Â  const ac=document.createElement('div');
Â  Â  Â  Â  ac.className='mt-4 pt-4 border-t flex flex-wrap justify-end gap-3';
Â  Â  Â  Â  const c=document.createElement('button');
Â  Â  Â  Â  c.type='button';
Â  Â  Â  Â  c.textContent=`ğŸ“‹ Sao chÃ©p ${info.groupName}`;
Â  Â  Â  Â  c.className='py-2 px-3 bg-blue-600 text-white rounded-lg classic';
Â  Â  Â  Â  c.onclick=()=>copyTabGroupData(info.type,name);
Â  Â  Â  Â  ac.appendChild(c);
Â  Â  Â  Â  const p=document.createElement('button');
Â  Â  Â  Â  p.type='button';
Â  Â  Â  Â  p.textContent=`â¬‡ï¸ DÃ¡n vÃ o ${info.groupName}`;
Â  Â  Â  Â  p.className='py-2 px-3 bg-blue-400 text-white rounded-lg classic';
Â  Â  Â  Â  p.onclick=()=>pasteTabGroupData(info.type,name);
Â  Â  Â  Â  ac.appendChild(p);
Â  Â  Â  Â  const clr=document.createElement('button');
Â  Â  Â  Â  clr.type='button';
Â  Â  Â  Â  clr.textContent='ğŸ—‘ï¸ XÃ³a Tab nÃ y';
Â  Â  Â  Â  clr.className='py-2 px-3 bg-red-400 text-white rounded-lg classic';
Â  Â  Â  Â  clr.onclick=()=>clearTabGroupData(name);
Â  Â  Â  Â  ac.appendChild(clr);
Â  Â  Â  Â  node.appendChild(ac);
Â  Â  Â  }
Â  Â  }
Â  Â  content.appendChild(node);
Â  });
Â  if(Object.keys(FIELDS).length)openTab(null,Object.keys(FIELDS)[0]);
}

function copyTabGroupData(type, sourceTabName) {
Â  // Placeholder implementation for copy function
Â  show(`ÄÃ£ sao chÃ©p dá»¯ liá»‡u nhÃ³m ${type === 'dat' ? 'Äáº¥t' : 'NhÃ '}. (Chá»©c nÄƒng nÃ y cáº§n Ä‘Æ°á»£c triá»ƒn khai Ä‘áº§y Ä‘á»§)`, 'info');
}

function pasteTabGroupData(type, targetTabName) {
Â  // Placeholder implementation for paste function
Â  show(`ÄÃ£ dÃ¡n dá»¯ liá»‡u nhÃ³m ${type === 'dat' ? 'Äáº¥t' : 'NhÃ '}. (Chá»©c nÄƒng nÃ y cáº§n Ä‘Æ°á»£c triá»ƒn khai Ä‘áº§y Ä‘á»§)`, 'info');
}

function clearTabGroupData(tabName) {
Â  // Placeholder implementation for clear function
Â  const cfg = FIELDS[tabName];
Â  if (cfg && !cfg.isTable) {
Â  Â  cfg.forEach(f => {
Â  Â  Â  const el = document.getElementById(f.id);
Â  Â  Â  if (el) el.value = '';
Â  Â  });
Â  Â  show(`ÄÃ£ xÃ³a sáº¡ch dá»¯ liá»‡u trong tab ${tabName}.`, 'success');
Â  }
}
function addRow(tab,isInit=false){
Â  const cfg=getTableConfig(tab);
Â  if(!cfg||!cfg.isTable) return;
Â Â 
Â  const tbody=document.querySelector(`#${CSS.escape(tab)} .table-body`);
Â  if(!tbody) return;
Â  rowIdx++;
Â  const tr=document.createElement('tr');
Â  tr.id='r'+rowIdx;
Â  tr.className='border-b hover:bg-amber-50';
Â  cfg.fields.forEach(f=>{
Â  Â  const td=document.createElement('td');
Â  Â  if(f.id.startsWith('stt')){
Â  Â  Â  td.className='p-2 font-bold text-center';
Â  Â  Â  td.innerHTML='<span class="stt"></span>';
Â  Â  }else{
Â  Â  Â  td.className='p-1';
Â  Â  Â  const inp=document.createElement('input');
Â  Â  Â  inp.type='text';
Â  Â  Â  inp.name=f.id;
Â  Â  Â  inp.className='table-input text-sm';
Â  Â  Â  if(f.readonly) {
Â  Â  Â  Â  inp.readOnly=true;
Â  Â  Â  Â  inp.classList.add('bg-stone-100');
Â  Â  Â  }
Â  Â  Â  if(f.type==='currency-integer-table'){
Â  Â  Â  Â  inp.oninput=()=>{
Â  Â  Â  Â  Â  let v=inp.value.replace(/\D/g,'');
Â  Â  Â  Â  Â  inp.value=v?numFmt(v):'';
Â  Â  Â  Â  };
Â  Â  Â  Â  inp.style.textAlign='right';
Â  Â  Â  }
Â  Â  Â  if(f.type==='currency-decimal-table'){
Â  Â  Â  Â  inp.oninput=()=>{
Â  Â  Â  Â  Â  inp.value=numFmtDecimal(inp.value);
Â  Â  Â  Â  };
Â  Â  Â  Â  inp.style.textAlign='right';
Â  Â  Â  }
Â  Â  Â  if(f.type==='percent-integer-table'){
Â  Â  Â  Â  inp.oninput=()=>{
Â  Â  Â  Â  Â  let v=inp.value.replace(/[^0-9]/g,'');
Â  Â  Â  Â  Â  if(v){
Â  Â  Â  Â  Â  Â  let num=parseInt(v);
Â  Â  Â  Â  Â  Â  if(num>100) num=100;
Â  Â  Â  Â  Â  Â  inp.value=num;
Â  Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  Â  inp.value='';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  inp.style.textAlign='right';
Â  Â  Â  Â  if(!f.readonly){
Â  Â  Â  Â  Â  inp.addEventListener('blur',function(){
Â  Â  Â  Â  Â  Â  if(this.value!=='') this.value=this.value+'%';
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  inp.addEventListener('focus',function(){
Â  Â  Â  Â  Â  Â  this.value=this.value.replace(/%/g,'');
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  if(f.type==='percent-decimal-table'){
Â  Â  Â  Â  inp.oninput=()=>{
Â  Â  Â  Â  Â  let v=inp.value.replace(/[^0-9,]/g,'');
Â  Â  Â  Â  Â  const parts=v.split(',');
Â  Â  Â  Â  Â  if(parts.length>2) v=parts[0]+','+parts.slice(1).join('');
Â  Â  Â  Â  Â  inp.value=v;
Â  Â  Â  Â  };
Â  Â  Â  Â  inp.style.textAlign='right';
Â  Â  Â  Â  if(!f.readonly){
Â  Â  Â  Â  Â  inp.addEventListener('blur',function(){
Â  Â  Â  Â  Â  Â  let raw=this.value.replace(/%/g,'').replace(/,/g,'.');
Â  Â  Â  Â  Â  Â  if(raw!==''){
Â  Â  Â  Â  Â  Â  Â  let num=parseFloat(raw);
Â  Â  Â  Â  Â  Â  Â  if(isNaN(num)) num=0;
Â  Â  Â  Â  Â  Â  Â  if(num>100) num=100;
Â  Â  Â  Â  Â  Â  Â  this.value=(Math.round(num*100)/100).toFixed(2).replace('.',',')+' %';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  inp.addEventListener('focus',function(){
Â  Â  Â  Â  Â  Â  this.value=this.value.replace(/\s?%/g,'');
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  td.appendChild(inp);
Â  Â  }
Â  Â  tr.appendChild(td);
Â  });
Â  const del=document.createElement('td');
Â  del.className='p-2 text-center w-[50px]';
Â  const db=document.createElement('button');
Â  db.type='button';
Â  db.textContent='âŒ';
Â  db.className='text-red-600 p-1 rounded-full bg-red-100';
Â  db.onclick=()=>{
Â  Â  tr.remove();
Â  Â  updNums(tab);
Â  };
Â  del.appendChild(db);
Â  tr.appendChild(del);
Â  tbody.appendChild(tr);
Â  updNums(tab);
Â  if(cfg.dataKey==='bang_giatri_dinhgia') attachRowCalc(tr,cfg);
Â  if(!isInit){
Â  Â  tr.scrollIntoView({behavior:'smooth',block:'end'});
Â  Â  const fi=tr.querySelector('input');
Â  Â  if(fi) fi.focus();
Â  }
}
function updNums(tab){
Â  const cfg=getTableConfig(tab);
Â  if (!cfg) return;
Â  const rows=document.querySelectorAll(`#${CSS.escape(tab)} .table-body tr`);
Â  rows.forEach((r,i)=>{
Â  Â  const s=r.querySelector('.stt');
Â  Â  if(s) s.textContent=i+1;
Â  });
Â  if(tab==='11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') updateTotalRow();
}
function collectData(){
Â  const out={};
Â  Object.keys(FIELDS).forEach(tab=>{
Â  Â  const cfg=FIELDS[tab];
Â  Â  if(cfg.isTable){
Â  Â  Â  const arr=[];
Â  Â  Â  const rows=document.querySelectorAll(`#${CSS.escape(tab)} .table-body tr`);
Â  Â  Â  rows.forEach(r=>{
Â  Â  Â  Â  const obj={};
Â  Â  Â  Â  const stt=r.querySelector('.stt');
Â  Â  Â  Â  const sttId=cfg.fields.find(f=>f.id.startsWith('stt')).id;
Â  Â  Â  Â  obj[sttId]=stt?stt.textContent:'';
Â  Â  Â  Â  r.querySelectorAll('input').forEach(inp=>{
Â  Â  Â  Â  Â  let v=inp.value;
Â  Â  Â  Â  Â  const fd=cfg.fields.find(f=>f.id===inp.name);
Â  Â  Â  Â  Â  if(fd?.type==='currency-integer-table'||fd?.type==='currency-decimal-table') v=String(v).replace(/\./g,'').replace(/,/g,'.');
Â  Â  Â  Â  Â  if(fd?.type==='percent-integer-table'||fd?.type==='percent-decimal-table') v=String(v).replace(/\s?%/g,'').replace(/,/g,'.');
Â  Â  Â  Â  Â  obj[inp.name]=v;
Â  Â  Â  Â  });
Â  Â  Â  Â  const has=Object.keys(obj).some(k=>k!==sttId&&obj[k]);
Â  Â  Â  Â  if(has) arr.push(obj);
Â  Â  Â  });
Â  Â  Â  out[cfg.dataKey]=arr;
Â  Â  Â Â 
Â  Â  Â  // Bá»• sung thu tháº­p giÃ¡ trá»‹ tá»•ng (Tab 11)
Â  Â  Â  if (tab === '11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') {
Â  Â  Â  Â  out['tong_thanhtien_bangdgts'] = parseVN($('#tong_thanhtien_bangdgts')?.value || '').toString();
Â  Â  Â  Â  out['tong_thanhtienlamtron_bangdgts'] = parseVN($('#tong_thanhtienlamtron_bangdgts')?.value || '').toString();
Â  Â  Â  Â  out['tong_mucctdtoida_bangdgts'] = parseVN($('#tong_mucctdtoida_bangdgts')?.value || '').toString();
Â  Â  Â  Â  out['tong_tyleBOA_bangdgts'] = parseVN($('#tong_tyleBOA_bangdgts')?.value.replace(' %', '') || '').toString();
Â  Â  Â  Â  out['tonggiatri_tsbd_bangso'] = parseVN($('#tonggiatri_tsbd_bangso')?.value || '').toString();
Â  Â  Â  Â  out['tonggiatri_tsbd_bangchu'] = $('#tonggiatri_tsbd_bangchu')?.value || '';
Â  Â  Â  }
Â  Â  }else{
Â  Â  Â  cfg.forEach(f=>{
Â  Â  Â  Â  const el=document.getElementById(f.id);
Â  Â  Â  Â  if(el){
Â  Â  Â  Â  Â  let v=el.value;
Â  Â  Â  Â  Â  out[f.id]=v;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  // Logic thu tháº­p dá»¯ liá»‡u báº£ng gá»™p (Khung giÃ¡ Ä‘áº¥t)
Â  Â  Â  if (tab === "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡") {
Â  Â  Â  Â  const tableConfig = LAND_PRICE_TABLE_CONFIG;
Â  Â  Â  Â  const arr = [];
Â  Â  Â  Â  const rows = document.querySelectorAll(`#${CSS.escape(MERGED_LAND_PRICE_TAB_ID)} .table-body tr`);
Â  Â  Â  Â  rows.forEach(r => {
Â  Â  Â  Â  Â  const obj = {};
Â  Â  Â  Â  Â  const stt = r.querySelector('.stt');
Â  Â  Â  Â  Â  const sttId = tableConfig.fields.find(f => f.id.startsWith('stt')).id;
Â  Â  Â  Â  Â  obj[sttId] = stt ? stt.textContent : '';
Â  Â  Â  Â  Â  r.querySelectorAll('input').forEach(inp => {
Â  Â  Â  Â  Â  Â  let v = inp.value;
Â  Â  Â  Â  Â  Â  const fd = tableConfig.fields.find(f => f.id === inp.name);
Â  Â  Â  Â  Â  Â  if (fd?.type === 'currency-integer-table' || fd?.type === 'currency-decimal-table') v = String(v).replace(/\./g, '').replace(/,/g, '.');
Â  Â  Â  Â  Â  Â  if (fd?.type === 'percent-integer-table' || fd?.type === 'percent-decimal-table') v = String(v).replace(/\s?%/g,'').replace(/,/g,'.');
Â  Â  Â  Â  Â  Â  obj[inp.name] = v;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const has = Object.keys(obj).some(k => k !== sttId && obj[k]);
Â  Â  Â  Â  Â  if (has) arr.push(obj);
Â  Â  Â  Â  });
Â  Â  Â  Â  out[tableConfig.dataKey] = arr;
Â  Â  Â  }
Â  Â  }
Â  });
Â  return out;
}
function populateForm(data){
Â  Object.keys(FIELDS).forEach(tab=>{
Â  Â  const cfg=FIELDS[tab];
Â  Â  if(cfg.isTable){
Â  Â  Â  const arr=data[cfg.dataKey]||[];
Â  Â  Â  const tb=document.querySelector(`#${CSS.escape(tab)} .table-body`);
Â  Â  Â  if(!tb) return;
Â  Â  Â  tb.innerHTML='';
Â  Â  Â  if(arr.length===0){
Â  Â  Â  Â  addRow(tab,true);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  arr.forEach(rd=>{
Â  Â  Â  Â  addRow(tab,true);
Â  Â  Â  Â  const nr=tb.lastElementChild;
Â  Â  Â  Â  cfg.fields.forEach(f=>{
Â  Â  Â  Â  Â  const inp=nr.querySelector(`input[name="${f.id}"]`);
Â  Â  Â  Â  Â  if(inp&&rd[f.id]!==undefined){
Â  Â  Â  Â  Â  Â  let v=rd[f.id];
Â  Â  Â  Â  Â  Â  if(f.type==='currency-integer-table'){
Â  Â  Â  Â  Â  Â  Â  const d=String(v).replace(/\D/g,'');
Â  Â  Â  Â  Â  Â  Â  v=d?numFmt(d):'';
Â  Â  Â  Â  Â  Â  }else if(f.type==='currency-decimal-table'){
Â  Â  Â  Â  Â  Â  Â  // *** FIX STARTS HERE ***
Â  Â  Â  Â  Â  Â  Â  // The value from JSON is in standard format "100.45".
Â  Â  Â  Â  Â  Â  Â  // We just need to replace the dot with a comma for display.
Â  Â  Â  Â  Â  Â  Â  // The old method `numFmtDecimal` was incorrect for this case.
Â  Â  Â  Â  Â  Â  Â  v = String(v).replace('.', ',');
Â  Â  Â  Â  Â  Â  Â  // *** FIX ENDS HERE ***
Â  Â  Â  Â  Â  Â  }else if(f.type==='percent-integer-table'){
Â  Â  Â  Â  Â  Â  Â  const raw=String(v).replace(/[^0-9]/g,'');
Â  Â  Â  Â  Â  Â  Â  if(raw==='') v='';
Â  Â  Â  Â  Â  Â  Â  else{
Â  Â  Â  Â  Â  Â  Â  Â  let num=parseInt(raw);
Â  Â  Â  Â  Â  Â  Â  Â  if(num>100) num=100;
Â  Â  Â  Â  Â  Â  Â  Â  v=num+'%';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â   }else if(f.type==='percent-decimal-table'){
Â  Â  Â  Â  Â  Â  Â  const raw=String(v).replace(/,/g,'.').replace(/[^0-9\.]/g,'');
Â  Â  Â  Â  Â  Â  Â  if(raw==='') v='';
Â  Â  Â  Â  Â  Â  Â  else{
Â  Â  Â  Â  Â  Â  Â  Â  let num=parseFloat(raw);
Â  Â  Â  Â  Â  Â  Â  Â  if(isNaN(num)) num=0;
Â  Â  Â  Â  Â  Â  Â  Â  if(num>100) num=100;
Â  Â  Â  Â  Â  Â  Â  Â  v=(f.id==='tyleboa_bangdgts')?(Math.round(num*100)/100).toFixed(2).replace('.',',')+' %':(Math.round(num*100)/100).toFixed(2).replace('.',',')+'%';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  inp.value=v;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  updNums(tab);
Â  Â  Â  });

Â  Â  Â  // Bá»• sung Ä‘iá»n dá»¯ liá»‡u cho cÃ¡c trÆ°á»ng tá»•ng (Tab 11)
Â  Â  Â  if (tab === '11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') {
Â  Â  Â  Â  // TÃ¡i tÃ­nh toÃ¡n tá»•ng ngay láº­p tá»©c sau khi Ä‘iá»n dá»¯ liá»‡u vÃ o báº£ng
Â  Â  Â  Â  updateTotalRow();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Sau Ä‘Ã³, kiá»ƒm tra xem cÃ³ giÃ¡ trá»‹ Ä‘Ã£ lÆ°u cho tá»•ng sá»‘ (Ä‘Æ°á»£c tÃ­nh toÃ¡n Ä‘á»™c láº­p) khÃ´ng.
Â  Â  Â  Â  // Trong trÆ°á»ng há»£p nÃ y, chÃºng ta cho phÃ©p updateTotalRow() ghi Ä‘Ã¨ Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh toÃ¡n má»›i nháº¥t
Â  Â  Â  Â  // dá»±a trÃªn dá»¯ liá»‡u báº£ng Ä‘Æ°á»£c Ä‘iá»n.
Â  Â  Â  }
Â  Â  }else{
Â  Â  Â  cfg.forEach(f=>{
Â  Â  Â  Â  const el=document.getElementById(f.id);
Â  Â  Â  Â  if(el&&data[f.id]!==undefined){
Â  Â  Â  Â  Â  let v=data[f.id];
Â  Â  Â  Â  Â  el.value=v;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  // Logic Ä‘iá»n dá»¯ liá»‡u báº£ng gá»™p (Khung giÃ¡ Ä‘áº¥t)
Â  Â  Â  if (tab === "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡") {
Â  Â  Â  Â  const tableConfig = LAND_PRICE_TABLE_CONFIG;
Â  Â  Â  Â  const arr = data[tableConfig.dataKey] || [];
Â  Â  Â  Â  const tb = document.querySelector(`#${CSS.escape(MERGED_LAND_PRICE_TAB_ID)} .table-body`);
Â  Â  Â  Â  if(!tb) return;
Â  Â  Â  Â  tb.innerHTML = '';
Â  Â  Â  Â  if(arr.length === 0){
Â  Â  Â  Â  Â  addRow(MERGED_LAND_PRICE_TAB_ID, true);
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  arr.forEach(rd => {
Â  Â  Â  Â  Â  addRow(MERGED_LAND_PRICE_TAB_ID, true);
Â  Â  Â  Â  Â  const nr = tb.lastElementChild;
Â  Â  Â  Â  Â  tableConfig.fields.forEach(f => {
Â  Â  Â  Â  Â  Â  const inp = nr.querySelector(`input[name="${f.id}"]`);
Â  Â  Â  Â  Â  Â  if(inp && rd[f.id] !== undefined){
Â  Â  Â  Â  Â  Â  Â  let v = rd[f.id];
Â  Â  Â  Â  Â  Â  Â  if(f.type==='currency-integer-table'){
Â  Â  Â  Â  Â  Â  Â  Â  const d=String(v).replace(/\D/g,'');
Â  Â  Â  Â  Â  Â  Â  Â  v=d?numFmt(d):'';
Â  Â  Â  Â  Â  Â  Â  }else if(f.type==='currency-decimal-table'){
Â  Â  Â  Â  Â  Â  Â  Â  v = String(v).replace('.', ','); // Apply same fix here
Â  Â  Â  Â  Â  Â  Â  }else if(f.type==='percent-integer-table'){
Â  Â  Â  Â  Â  Â  Â  Â  const raw=String(v).replace(/[^0-9]/g,'');
Â  Â  Â  Â  Â  Â  Â  Â  if(raw==='') v='';
Â  Â  Â  Â  Â  Â  Â  Â  else{
Â  Â  Â  Â  Â  Â  Â  Â  Â  let num=parseInt(raw);
Â  Â  Â  Â  Â  Â  Â  Â  Â  if(num>100) num=100;
Â  Â  Â  Â  Â  Â  Â  Â  Â  v=num+'%';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }else if(f.type==='percent-decimal-table'){
Â  Â  Â  Â  Â  Â  Â  Â  const raw=String(v).replace(/,/g,'.').replace(/[^0-9\.]/g,'');
Â  Â  Â  Â  Â  Â  Â  Â  if(raw==='') v='';
Â  Â  Â  Â  Â  Â  Â  Â  else{
Â  Â  Â  Â  Â  Â  Â  Â  Â  let num=parseFloat(raw);
Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isNaN(num)) num=0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  if(num>100) num=100;
Â  Â  Â  Â  Â  Â  Â  Â  Â  v=(f.id==='tyleboa_bangdgts')?(Math.round(num*100)/100).toFixed(2).replace('.',',')+' %':(Math.round(num*100)/100).toFixed(2).replace('.',',')+'%';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  inp.value=v;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  updNums(MERGED_LAND_PRICE_TAB_ID);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  });
}
let templateFile=null;
$('#templateFile').addEventListener('change',e=>{
Â  templateFile=e.target.files[0];
Â  $('#templateFileName').textContent=templateFile?`File: ${templateFile.name}`:'ChÆ°a chá»n file';
});
$('#loadFileInput').addEventListener('change',e=>{
Â  const f=e.target.files[0];
Â  if(!f) return;
Â  const r=new FileReader();
Â  r.onload=ev=>{
Â  Â  try{
Â  Â  Â  const d=JSON.parse(ev.target.result);
Â  Â  Â  populateForm(d);
Â  Â  Â  show('ÄÃ£ táº£i dá»¯ liá»‡u','success');
Â  Â  Â  // KÃ­ch hoáº¡t tÃ­nh tá»•ng sau khi táº£i dá»¯ liá»‡u Ä‘á»ƒ Ä‘áº£m báº£o chÃ­nh xÃ¡c
Â  Â  Â  updateTotalRow();Â 
Â  Â  }catch(err){
Â  Â  Â  show('Lá»—i JSON','error');
Â  Â  }
Â  };
Â  r.readAsText(f);
});
$('#profileForm').addEventListener('submit',async e=>{
Â  e.preventDefault();
Â  if(!templateFile){
Â  Â  show('Vui lÃ²ng chá»n template','error');
Â  Â  return;
Â  }
Â  const data=collectData();
Â  const buffer=await new Promise(r=>{
Â  Â  const fr=new FileReader();
Â  Â  fr.onload=ev=>r(ev.target.result);
Â  Â  fr.readAsArrayBuffer(templateFile);
Â  });
Â  const fd=new FormData();
Â  fd.append('template',new Blob([buffer],{type:templateFile.type}),templateFile.name);
Â  fd.append('data',JSON.stringify(data));
Â  show('Äang táº¡o DOCX...','info');
Â  $('#btn-generate').disabled=true;
Â  try{
    // *** START CHANGE: Removed hardcoded URL ***
Â  Â  const resp=await fetch('/generate',{method:'POST',body:fd});
    // *** END CHANGE ***
Â  Â  if(!resp.ok)throw new Error(`${resp.status} ${resp.statusText}`);
Â  Â  const blob=await resp.blob();
Â  Â  const name=`HoSoTSBD_${templateFile.name.replace('.docx','')}_${new Date().toISOString().slice(0,10)}.docx`;
Â  Â  const url=URL.createObjectURL(blob);
Â  Â  const a=document.createElement('a');
Â  Â  a.href=url;
Â  Â  a.download=name;
Â  Â  document.body.appendChild(a);
Â  Â  a.click();
Â  Â  a.remove();
Â  Â  URL.revokeObjectURL(url);
Â  Â  show('Táº¡o DOCX thÃ nh cÃ´ng','success');
Â  }catch(err){
Â  Â  show('Lá»—i khi táº¡o DOCX: '+err.message,'error');
Â  }finally{
Â  Â  $('#btn-generate').disabled=false;
Â  }
});
function saveData(){
Â  const d=collectData();
Â  const s=JSON.stringify(d,null,2);
Â  const b=new Blob([s],{type:'application/json'});
Â  const u=URL.createObjectURL(b);
Â  const a=document.createElement('a');
Â  a.href=u;
Â  a.download=`DuLieuHoSoTSBD_${new Date().toISOString().slice(0,10)}.json`;
Â  document.body.appendChild(a);
Â  a.click();
Â  a.remove();
Â  URL.revokeObjectURL(u);
Â  show('ÄÃ£ lÆ°u nhÃ¡p','info');
}

window.onload=()=>{
Â  generateForm();
Â  document.querySelectorAll('.classic').forEach(b=>{
Â  Â  if(!b.style.boxShadow){
Â  Â  Â  b.style.boxShadow='0 4px 0 rgba(0,0,0,.4)';
Â  Â  Â  b.style.borderBottom='2px solid rgba(0,0,0,.4)';
Â  Â  }
Â  });
}
</script>
</body>
</html>
