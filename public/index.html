<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Soáº¡n Há»“ sÆ¡ TSBÄ â€” Compact</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">
<style>
Â  html{font-family:'Lora',serif}
Â  .classic{transition:.15s;box-shadow:0 4px 0 rgba(0,0,0,.4);border-bottom:2px solid rgba(0,0,0,.4)}
Â  .tabbtn{border-radius:8px 8px 0 0;border:2px solid transparent}
Â  .table-input{width:100%;padding:.5rem;border:1px solid #d1d5db;border-radius:4px; transition: background-color 0.1s;}
Â  .stt{min-height:2.5rem;display:flex;align-items:center;justify-content:center}
  .template-btn.active { background-color: #4d7c0f; /* green-700 */ border-color: #a3e635; /* lime-400 */ color: white; }
</style>
</head>
<body class="bg-stone-100 p-4 md:p-10 text-gray-800">
<div class="mx-auto max-w-6xl bg-amber-50 p-6 md:p-10 rounded-xl shadow-2xl border-4 border-amber-800/80">
Â  <h1 class="text-3xl font-bold text-amber-900 mb-4 text-center tracking-wider border-b-2 border-amber-700 pb-3">ğŸ“ á»¨ng dá»¥ng Soáº¡n tháº£o Há»“ sÆ¡ TÃ i sáº£n Báº£o Ä‘áº£m</h1>
Â  <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-lg text-sm">
    <p class="font-bold">HÃ£y bÃ¬nh chá»n cho PGD ChÃ¢u Thá»‹ Kim náº¿u báº¡n tháº¥y á»©ng dá»¥ng há»¯u Ã­ch vÃ  ChÃºng tÃ´i sáº½ cÃ³ Ä‘á»™ng lá»±c Ä‘á»ƒ phÃ¡t triá»ƒn thÃªm cÃ¡c á»©ng dá»¥ng khÃ¡c há»— trá»£ báº¡n trong cÃ´ng viá»‡c.</p>
    <p class="mt-2">á»¨ng dá»¥ng Ä‘ang trong quÃ¡ trÃ¬nh váº­n hÃ nh thá»­ nghiá»‡m, ráº¥t mong nháº­n Ä‘Æ°á»£c gÃ³p Ã½ cá»§a cÃ¡c báº¡n Ä‘á»ƒ á»©ng dá»¥ng hoÃ n thiá»‡n tá»‘t nháº¥t. Má»i gÃ³p Ã½ vui lÃ²ng liÃªn há»‡: <b>dtnghia</b></p>
Â  </div>

  <div class="border-2 border-amber-700/50 rounded-lg p-4 mb-6 bg-amber-100/50">
      <h2 class="text-xl font-bold text-amber-900 mb-3 text-center">Chá»n loáº¡i há»“ sÆ¡ TSBÄ cáº§n táº¡o</h2>
      
      <div id="templateButtonsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <!-- CÃ¡c nÃºt template sáº½ Ä‘Æ°á»£c táº¡o báº±ng JavaScript -->
      </div>
      <div class="text-center mt-3">
          <span class="font-bold text-amber-900">ÄÃ£ chá»n:</span>
          <span id="templateFileName" class="italic text-red-700 font-semibold">ChÆ°a chá»n há»“ sÆ¡</span>
      </div>
  </div>

Â  <div class="flex flex-wrap justify-center gap-4 mb-6">
Â  Â  <button id="btn-save" onclick="saveData()" class="py-2 px-4 bg-yellow-700 text-white rounded-lg classic">ğŸ’¾ LÆ°u dá»¯ liá»‡u Ä‘Ã£ nháº­p</button>
Â  Â  <input id="loadFileInput" type="file" accept=".json" hidden>
Â  Â  <button onclick="$('#loadFileInput').click()" class="py-2 px-4 bg-yellow-700 text-white rounded-lg classic">ğŸ“¥ Táº£i lÃªn dá»¯ liá»‡u Ä‘Ã£ nháº­p</button>
Â  </div>

Â  <div id="tabMenu" class="flex flex-wrap gap-2 mb-4"></div>
Â  <form id="profileForm">
Â  Â  <div id="tabContent" class="p-6 border-2 border-amber-700 bg-white rounded-b-xl rounded-tr-xl shadow-inner"></div>
Â  Â  <div class="text-center mt-8"><button id="btn-generate" class="py-3 px-8 bg-green-700 text-white rounded-lg classic">âœï¸ Táº¡o & Táº£i DOCX</button></div>
Â  </form>
Â  <div id="message" class="hidden mt-4 p-3 rounded-lg font-bold text-center"></div>
</div>

<script>
// YÃªu cáº§u má»›i: Danh sÃ¡ch cÃ¡c template Ä‘Æ°á»£c tÃ­ch há»£p sáºµn
const TEMPLATES = [
    { name: "1. BiÃªn báº£n Ä‘á»‹nh giÃ¡ tÃ i sáº£n", path: "template_MB02_Bien ban dinh gia_QSDD.docx" },
    { name: "2. ÄÄƒng Ä‘Äƒng kÃ½ tháº¿ cháº¥p", path: "template_Don DKTC ND99 2022.docx" },
    { name: "3. Tá» trÃ¬nh tháº©m Ä‘á»‹nh TSBÄ (khÃ´ng qua AMC)", path: "template_BM05b TT tham dinh TSBD khong qua AMC.docx" },
    { name: "4. Tá» trÃ¬nh tháº©m Ä‘á»‹nh TSBÄ (qua AMC)", path: "template_BM05a TT tham dinh TSBD qua AMC.docx" },
    { name: "5. BiÃªn báº£n giao nháº­n há»“ sÆ¡ TSBÄ", path: "template_BM02_BB giao nhan ho so TSBD.docx" },
    { name: "6. Báº£n mÃ´ táº£ vá»‹ trÃ­ thá»­a Ä‘áº¥t", path: "template_Ban mo ta vi tri thua dat.docx" },
    { name: "7. Giáº¥y cam káº¿t tháº¿ cháº¥p TSBÄ cá»§a KhÃ¡ch hÃ ng", path: "template_Giay cam ket the chap TSBD.docx" },
    { name: "8. CÃ´ng vÄƒn ThÃ´ng bÃ¡o TÃ i sáº£n tháº¿ cháº¥p cá»§a NHCT", path: "template_CV Thong bao tai san the chap.docx" }
];
let selectedTemplate = null; // Biáº¿n lÆ°u trá»¯ template Ä‘Ã£ chá»n vÃ  táº£i vá»

// \u00B2 lÃ  kÃ½ tá»± m^2
const BASE_DAT=[
Â  {id:"ten_tsbd$X$",label:"TÃªn tÃ i sáº£n báº£o Ä‘áº£m (TSBÄ) $X$",type:"text"},
Â  {id:"hoso_tsbd$X$",label:"Há»“ sÆ¡ TSBÄ $X$",type:"textarea"},
Â  {id:"sothuadat_tsbd$X$",label:"Sá»‘ Thá»­a Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"tobando_tsbd$X$",label:"Sá»‘ Tá» báº£n Ä‘á»“ TSBÄ $X$",type:"text"},
Â  {id:"dientichdat_tsbd$X$",label:"Diá»‡n tÃ­ch Ä‘áº¥t TSBÄ $X$ (m\u00B2)",type:"text"},
Â  {id:"dientichdatbangchu_tsbd$X$",label:"Diá»‡n tÃ­ch Ä‘áº¥t TSBÄ $X$ (báº±ng chá»¯)",type:"text"},
Â  {id:"loaidat_tsbd$X$",label:"Loáº¡i Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"thoihansudungdat_tsbd$X$",label:"Thá»i háº¡n sá»­ dá»¥ng Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"hinhthucsudungdat_tsbd$X$",label:"HÃ¬nh thá»©c sá»­ dá»¥ng Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"diachi_tsbd$X$",label:"Äá»‹a chá»‰ TSBÄ $X$",type:"text"},
Â  {id:"nguongoc_tsbd$X$",label:"Nguá»“n gá»‘c sá»­ dá»¥ng Ä‘áº¥t TSBÄ $X$",type:"text"},
Â  {id:"ghichu_tsbd$X$",label:"Ghi chÃº TSBÄ $X$",type:"textarea"},
Â  {id:"vitridat_tsbd$X$",label:"Vá»‹ trÃ­ Ä‘áº¥t TSBÄ $X$ theo Khung giÃ¡ UBND",type:"text"},
Â  {id:"sodothuadat_tsbd$X$",label:"SÆ¡ Ä‘á»“ thá»­a Ä‘áº¥t TSBÄ $X$",type:"textarea"},
Â  {id:"thongtinquyhoach_tsbd$X$",label:"ThÃ´ng tin quy hoáº¡ch TSBÄ $X$",type:"text"},
Â  {id:"thongtintranhchap_tsbd$X$",label:"ThÃ´ng tin tranh cháº¥p TSBÄ $X$",type:"text"},
Â  {id:"hanche_tsbd$X$",label:"Háº¡n cháº¿ cá»§a TSBÄ $X$",type:"text"},
Â  {id:"hientrangkhac_tsbd$X$",label:"Hiá»‡n tráº¡ng khÃ¡c cá»§a TSBÄ $X$",type:"textarea"},
Â  {id:"noidungkhongphuhopphaply_tsbd$X$",label:"Ná»™i dung khÃ´ng phÃ¹ há»£p vá»›i há»“ sÆ¡ phÃ¡p lÃ½ TSBÄ $X$",type:"text"},
Â  {id:"phantichvitri_tsbd$X$",label:"PhÃ¢n tÃ­ch vá»‹ trÃ­ TSBÄ $X$",type:"textarea"},
Â  {id:"phantichsudung_tsbd$X$",label:"PhÃ¢n tÃ­ch tÃ¬nh hÃ¬nh sá»­ dá»¥ng TSBÄ $X$",type:"textarea"}
];
// ÄÃ£ thÃªm (mÂ²) vÃ o nhÃ£n (label)
const BASE_NHA=[
Â  {id:"loainhao_tsbd$X$",label:"Loáº¡i NhÃ  á»Ÿ TSBÄ $X$",type:"text"},
Â  {id:"dientichxd_tsbd$X$",label:"Diá»‡n tÃ­ch xÃ¢y dá»±ng TSBÄ $X$ (m\u00B2)",type:"text"},
Â  {id:"dientichsan_tsbd$X$",label:"Diá»‡n tÃ­ch sÃ n TSBÄ $X$ (m\u00B2)",type:"text"},
Â  {id:"hinhthucsohuu_tsbd$X$",label:"HÃ¬nh thá»©c sá»Ÿ há»¯u TSBÄ $X$",type:"text"},
Â  {id:"capnhao_tsbd$X$",label:"Cáº¥p (Háº¡ng) cÃ´ng trÃ¬nh TSBÄ $X$",type:"text"},
Â  {id:"thoihansohuu_tsbd$X$",label:"Thá»i háº¡n sá»Ÿ há»¯u nhÃ  á»Ÿ TSBÄ $X$",type:"text"}
];
function genTSBD(base,i){return base.map(f=>{const id=f.id.replace('$X$',i);return {id, label:f.label.replace('$X$',i), type:f.type, genericId:id.replace(`_tsbd${i}`,'')}})}

const LAND_PRICE_FIELDS=[
Â  {id:"stt_bangkg",label:"TT",type:"text",width:"w-[5%]"},
Â  {id:"loaidat_bangkg",label:"Loáº¡i Ä‘áº¥t",type:"text",width:"w-[10%]",placeholder:"VD: Äáº¥t á»Ÿ"},
Â  {id:"tenduongpho_bangkg",label:"TÃªn Ä‘Æ°á»ng phá»‘",type:"text",width:"w-[20%]"},
Â  {id:"doanduong_bangkg",label:"Äoáº¡n Ä‘Æ°á»ng (Tá»« - Äáº¿n)",type:"text",width:"w-[15%]"},
Â  {id:"dgdatvt1_bangkg",label:"ÄÆ¡n giÃ¡ VT1 (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12.5%]"},
Â  {id:"dgdatvt2_bangkg",label:"ÄÆ¡n giÃ¡ VT2 (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12.5%]"},
Â  {id:"dgdatvt3_bangkg",label:"ÄÆ¡n giÃ¡ VT3 (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12.5%]"},
Â  {id:"dgdatvt4_bangkg",label:"ÄÆ¡n giÃ¡ VT4 (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12.5%]"}
];
const LAND_VALUE_FIELDS=[
Â  {id:"stt_bangdgts",label:"TT",type:"text",width:"w-[4%]"},
Â  {id:"gcnts_bangdgts",label:"Giáº¥y chá»©ng nháº­n tÃ i sáº£n",type:"text",width:"w-[12%]"},
Â  {id:"sothuadat_bangdgts",label:"Sá»‘ thá»­a Ä‘áº¥t",type:"text",width:"w-[8%]"},
Â  {id:"hangmuc_bangdgts",label:"Háº¡ng má»¥c",type:"text",width:"w-[12%]"},
Â  {id:"dientich_bangdgts",label:"Diá»‡n tÃ­ch (m\u00B2)",type:"currency-decimal-table",width:"w-[8%]"},
Â  {id:"dongia_bangdgts",label:"ÄÆ¡n giÃ¡ (Ä‘á»“ng/m\u00B2)",type:"currency-integer-table",width:"w-[12%]"},
Â  {id:"clcl_bangdgts",label:"CLCL",type:"percent-integer-table",width:"w-[6%]"},
Â  {id:"thanhtien_bangdgts",label:"ThÃ nh tiá»n (Ä‘á»“ng)",type:"currency-integer-table",width:"w-[12%]",readonly:true},
Â  {id:"thanhtienlamtron_bangdgts",label:"ThÃ nh tiá»n lÃ m trÃ²n (Ä‘á»“ng)",type:"currency-integer-table",width:"w-[12%]",readonly:true},
Â  {id:"mucctdtoida_bangdgts",label:"Má»©c cáº¥p tÃ­n dá»¥ng tá»‘i Ä‘a (Ä‘á»“ng)",type:"currency-integer-table",width:"w-[12%]"},
Â  {id:"tyleboa_bangdgts",label:"Tá»· lá»‡ BOA",type:"percent-decimal-table",width:"w-[6%]",readonly:true},
Â  {id:"cancudinhgia_bangdgts",label:"CÄƒn cá»© Ä‘á»‹nh giÃ¡",type:"text",width:"w-[10%]"}
];

const LAND_PRICE_TABLE_CONFIG = {isTable:true,dataKey:'bang_khung_gia_dat',fields:LAND_PRICE_FIELDS};
const MERGED_LAND_PRICE_TAB_ID = '10-KhungGiaDat';

const FIELDS={
Â  "1. ThÃ´ng tin chung":[{id:"tieude_bbdg",label:"TiÃªu Ä‘á» biÃªn báº£n Ä‘á»‹nh giÃ¡",type:"select",options:["Äá»‹nh giÃ¡ tÃ i sáº£n báº£o Ä‘áº£m","Äá»‹nh giÃ¡ láº¡i tÃ i sáº£n báº£o Ä‘áº£m"]},{id:"so_bbdg",label:"Sá»‘ biÃªn báº£n",type:"text"},{id:"ngay_bbdg",label:"NgÃ y láº­p (dd/mm/yyyy)",type:"text"},{id:"thoigian_bbdg",label:"Thá»i gian láº­p (hh:mm)",type:"text"},{id:"noilap_bbdg",label:"NÆ¡i láº­p",type:"text"},{id:"thoigian_khaosattsbd",label:"Thá»i gian kháº£o sÃ¡t (hh:mm)",type:"text"},{id:"ngay_khaosattsbd",label:"NgÃ y kháº£o sÃ¡t (dd/mm/yyyy)",type:"text"}],
Â  "2. BÃªn nháº­n báº£o Ä‘áº£m":[{id:"bnbd",label:"TÃªn BÃªn Nháº­n Báº£o Äáº£m",type:"text"},{id:"gcndk_bnbd",label:"GCN Ä‘Äƒng kÃ½ doanh nghiá»‡p",type:"text"},{id:"diachi_bnbd",label:"Äá»‹a chá»‰",type:"text"}],
Â  "3. BÃªn báº£o Ä‘áº£m":[{id:"ten_bbd1",label:"TÃªn BBÄ 1",type:"text"},{id:"gttt_bbd1",label:"Giáº¥y tá» BBÄ 1",type:"text"},{id:"diachi_bbd1",label:"Äá»‹a chá»‰ BBÄ 1",type:"text"},{id:"ten_bbd2",label:"TÃªn BBÄ 2",type:"text"},{id:"gttt_bbd2",label:"Giáº¥y tá» BBÄ 2",type:"text"},{id:"diachi_bbd2",label:"Äá»‹a chá»‰ BBÄ 2",type:"text"}],
Â  "4. TÃ i sáº£n báº£o Ä‘áº£m 1 (Thá»­a Ä‘áº¥t)":genTSBD(BASE_DAT,1),
Â  "5. TÃ i sáº£n báº£o Ä‘áº£m 1 (NhÃ  á»Ÿ)":genTSBD(BASE_NHA,1),
Â  "6. TÃ i sáº£n báº£o Ä‘áº£m 2 (Thá»­a Ä‘áº¥t)":genTSBD(BASE_DAT,2),
Â  "7. TÃ i sáº£n báº£o Ä‘áº£m 2 (NhÃ  á»Ÿ)":genTSBD(BASE_NHA,2),
Â  "8. TÃ i sáº£n báº£o Ä‘áº£m 3 (Thá»­a Ä‘áº¥t)":genTSBD(BASE_DAT,3),
Â  "9. TÃ i sáº£n báº£o Ä‘áº£m 3 (NhÃ  á»Ÿ)":genTSBD(BASE_NHA,3),
Â  "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡":[{id:"cancudg",label:"CÄƒn cá»© Ä‘á»‹nh giÃ¡",type:"textarea"}],
Â  "11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡":{isTable:true,dataKey:'bang_giatri_dinhgia',fields:LAND_VALUE_FIELDS},
Â  "12. Há»£p Ä‘á»“ng báº£o Ä‘áº£m": [
Â  Â  {id:"ten_hdbd", label:"TÃªn Há»£p Ä‘á»“ng báº£o Ä‘áº£m", type:"text"},
Â  Â  {id:"so_hdbd", label:"Sá»‘ Há»£p Ä‘á»“ng báº£o Ä‘áº£m", type:"text"},
Â  Â  {id:"ten_benvay1", label:"TÃªn BÃªn Vay 1", type:"text"},
Â  Â  {id:"gttt_benvay1", label:"GTTT BÃªn Vay 1", type:"text"},
Â  Â  {id:"diachi_benvay1", label:"Äá»‹a chá»‰ BÃªn Vay 1", type:"text"},
Â  Â  {id:"ten_benvay2", label:"TÃªn BÃªn Vay 2", type:"text"},
Â  Â  {id:"gttt_benvay2", label:"GTTT BÃªn Vay 2", type:"text"},
Â  Â  {id:"diachi_benvay2", label:"Äá»‹a chá»‰ BÃªn Vay 2",type:"text"},
Â  Â  {id:"bpbdtheopd", label:"Biá»‡n phÃ¡p báº£o Ä‘áº£m theo phÃª duyá»‡t", type:"text"}
Â  ]
};
let copied={dat:null,nha:null};
let rowIdx=0;
const $=(s)=>document.querySelector(s);

function show(msg, type='info') {
Â  const d = $('#message');
Â  d.textContent = msg;
Â  d.className = 'mt-4 p-3 rounded-lg font-bold text-center';
Â  if (type === 'success') {
Â  Â  d.classList.add('bg-green-100', 'text-green-800');
Â  } else if (type === 'error') {
Â  Â  d.classList.add('bg-red-100', 'text-red-800');
Â  } else {
Â  Â  d.classList.add('bg-amber-100', 'text-amber-900');
Â  }
Â  d.classList.remove('hidden');
Â  setTimeout(() => d.classList.add('hidden'), 5000);
}

function numFmt(s){if(!s) return '';const d=String(s).replace(/\D/g,'');return d.replace(/\B(?=(\d{3})+(?!\d))/g,'.')}
function numFmtDecimal(s){if(!s) return '';let cleaned=String(s).replace(/[^\d,]/g,'');const parts=cleaned.split(',');if(parts.length>2) cleaned=parts[0]+','+parts.slice(1).join('');if(parts.length===2){return parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.')+','+parts[1]}return cleaned.replace(/\B(?=(\d{3})+(?!\d))/g,'.')}
function parseVN(str){if(!str) return 0;const cleaned=String(str).replace(/\./g,'').replace(/,/g,'.').replace(/[^0-9\.]/g,'');const n=parseFloat(cleaned);return isNaN(n)?0:n}
function readG(s){const u=['','má»™t','hai','ba','bá»‘n','nÄƒm','sÃ¡u','báº£y','tÃ¡m','chÃ­n'];if(!s) return '';s=('000'+s).slice(-3);const d1=+s[0],d2=+s[1],d3=+s[2];let r='';if(d1) r+=u[d1]+' trÄƒm';if(d2) r+=(r?' ':'')+(d2==1?'mÆ°á»i':u[d2]+' mÆ°Æ¡i');else if(d1 && d3) r+=(r?' ':'')+'láº»';if(d3) {r+=(r?' ':'');if(d2==1) r+= (d3==5?'lÄƒm':u[d3]); else if(d2>=2) r+=(d3==1?'má»‘t':(d3==5?'lÄƒm':u[d3])); else r+=u[d3]}return r.trim()}
function toWords(raw){let s=String(raw).replace(/\D/g,'');if(!s||s=='0') return 'KhÃ´ng Ä‘á»“ng';s=s.replace(/^0+/,'');const g=[];let t=s;while(t.length){const gl=t.length>3?3:t.length;g.unshift(t.slice(-gl));t=t.slice(0,-gl)};let out='';for(let i=0;i<g.length;i++){const gw=readG(g[i]);const idx=g.length-1-i;let u='';if(idx==1) u='nghÃ¬n';else if(idx==2) u='triá»‡u';else if(idx==3) u='tá»·';else if(idx==4) u='nghÃ¬n tá»·';if(gw){out+=(out?' ':'')+gw+(u?' '+u:'')}}out=out.replace(/tá»· triá»‡u/g,'tá»·').trim();return out.charAt(0).toUpperCase()+out.slice(1)+' Ä‘á»“ng'}

async function selectTemplate(templatePath, templateName, btnElement) {
    document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
    const nameSpan = $('#templateFileName');
    nameSpan.textContent = 'Äang táº£i...';
    try {
        const response = await fetch(`/templates/${templatePath}`);
        if (!response.ok) {
            throw new Error(`KhÃ´ng tÃ¬m tháº¥y file template trÃªn server: ${response.statusText}`);
        }
        const blob = await response.blob();
        selectedTemplate = {
            name: templateName,
            path: templatePath,
            blob: blob
        };
        nameSpan.textContent = templateName;
        show(`ÄÃ£ chá»n template: ${templateName}`, 'success');
        btnElement.classList.add('active');
    } catch (err) {
        nameSpan.textContent = 'Lá»—i khi táº£i template!';
        show(err.message, 'error');
        selectedTemplate = null;
    }
}

function generateTemplateButtons() {
    const container = $('#templateButtonsContainer');
    TEMPLATES.forEach(template => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = template.name;
        btn.className = 'template-btn w-full text-left py-2 px-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg classic text-sm';
        btn.onclick = () => selectTemplate(template.path, template.name, btn);
        container.appendChild(btn);
    });
}

function openTab(evt, tabName){
Â  const contents=document.getElementsByClassName('tab-content');
Â  for(let i=0;i<contents.length;i++) contents[i].style.display='none';
Â  const buttons=document.getElementById('tabMenu').getElementsByTagName('button');
Â  for(let i=0;i<buttons.length;i++){
Â  Â  buttons[i].className='py-2 px-4 text-sm font-semibold bg-stone-200 border-2 text-amber-900 tabbtn';
Â  }
Â  const current=document.getElementById(tabName);
Â  if(current) current.style.display='block';
Â  if(evt && evt.currentTarget) evt.currentTarget.className='py-2 px-4 text-sm font-semibold bg-white border-2 border-amber-700 text-amber-900 tabbtn';
Â  else if(buttons.length>0) buttons[0].className='py-2 px-4 text-sm font-semibold bg-white border-2 border-amber-700 text-amber-900 tabbtn';
}
function createField(f){
Â  const wr=document.createElement('div');
Â  wr.className='form-group mb-4';
Â  const lab=document.createElement('label');
Â  lab.htmlFor=f.id;
Â  lab.className='block mb-2 font-bold text-gray-700';
Â  lab.textContent=f.label+' (ID: '+f.id+'): ';
Â  wr.appendChild(lab);
Â  let inp;
Â  if(f.type==='textarea'){
Â  Â  inp=document.createElement('textarea');
Â  Â  inp.rows=3;
Â  Â  inp.className='w-full p-2 border-2 rounded-md';
Â  }else if(f.type==='select'){
Â  Â  inp=document.createElement('select');
Â  Â  inp.className='w-full p-2 border-2 rounded-md';
Â  Â  f.options.forEach(o=>{
Â  Â  Â  const op=document.createElement('option');
Â  Â  Â  op.value=o;
Â  Â  Â  op.textContent=o;
Â  Â  Â  inp.appendChild(op);
Â  Â  });
Â  }else{
Â  Â  inp=document.createElement('input');
Â  Â  inp.type='text';
Â  Â  inp.className='w-full p-2 border-2 rounded-md';
Â  }
Â  inp.id=f.id;
Â  inp.name=f.id;
Â  wr.appendChild(inp);
Â  return wr;
}
function getTableConfig(tabName) {
Â  if (tabName === MERGED_LAND_PRICE_TAB_ID) return LAND_PRICE_TABLE_CONFIG;
Â  const cfg = FIELDS[tabName];
Â  if (cfg && cfg.isTable) return cfg;
Â  return null;
}
function createTotalSummaryContainer(tabName,cfg){
Â  const cont=document.createElement('div');
Â  cont.className='mt-8 pt-6 border-t-2 border-amber-700 space-y-4';
Â  cont.innerHTML=`
Â  Â  <h3 class="text-xl font-bold text-amber-900 mb-3">Káº¿t quáº£ Ä‘á»‹nh giÃ¡ TÃ i sáº£n Báº£o Ä‘áº£m</h3>
Â  Â  <div class="space-y-4 p-4 border rounded-lg bg-yellow-50 shadow-inner">
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="tonggiatri_tsbd_bangso" class="block mb-2 font-bold text-gray-700">Tá»•ng giÃ¡ trá»‹ cÃ¡c tÃ i sáº£n báº£o Ä‘áº£m (báº±ng sá»‘) (Ä‘á»“ng) (ID: tonggiatri_tsbd_bangso):</label>
Â  Â  Â  Â  <div class="flex gap-2 items-center">
Â  Â  Â  Â  Â  <input type="text" id="tonggiatri_tsbd_bangso" name="tonggiatri_tsbd_bangso" readonly class="w-full p-2 border-2 rounded-md bg-stone-100 font-bold text-lg text-left">
Â  Â  Â  Â  Â  <button type="button" onclick="updateTotalRow()" class="flex-shrink-0 py-2 px-4 bg-amber-600 text-white rounded-lg classic text-sm whitespace-nowrap hover:bg-amber-700">TÃ­nh tá»•ng</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="tonggiatri_tsbd_bangchu" class="block mb-2 font-bold text-gray-700">Tá»•ng giÃ¡ trá»‹ cÃ¡c tÃ i sáº£n báº£o Ä‘áº£m (báº±ng chá»¯) (ID: tonggiatri_tsbd_bangchu):</label>
Â  Â  Â  Â  <textarea id="tonggiatri_tsbd_bangchu" name="tonggiatri_tsbd_bangchu" rows="2" readonly class="w-full p-2 border-2 rounded-md bg-stone-100 font-bold"></textarea>
Â  Â  Â  </div>
Â  Â  </div>
Â  `;
Â  return cont;
}

function renderTable(name,conf){
Â  const cont=document.createElement('div');
Â  cont.id=name;
Â  cont.className='tab-content';
Â  cont.style.display='none';
Â  const wrap=document.createElement('div');
Â  wrap.className='overflow-x-auto';
Â  const table=document.createElement('table');
Â  table.className='w-full divide-y border rounded-lg';
Â  const thead=document.createElement('thead');
Â  thead.className='bg-amber-100 sticky top-0';
Â  const hr=document.createElement('tr');
Â  conf.fields.forEach(f=>{
Â  Â  const th=document.createElement('th');
Â  Â  th.className='p-3 text-left text-xs font-semibold '+(f.width||'');
Â  Â  th.textContent=f.label;
Â  Â  hr.appendChild(th);
Â  });
Â  const act=document.createElement('th');
Â  act.className='p-3 text-center w-[50px]';
Â  act.textContent='XoÃ¡';
Â  hr.appendChild(act);
Â  thead.appendChild(hr);
Â  table.appendChild(thead);
Â  const tbody=document.createElement('tbody');
Â  tbody.className='bg-white table-body';
Â  table.appendChild(tbody);
Â  if (name === '11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') {
Â  Â  const tfoot=document.createElement('tfoot');
Â  Â  tfoot.className='bg-amber-200 font-bold border-t-2 border-amber-800';
Â  Â  tfoot.innerHTML=`
Â  Â  Â  <tr class="font-bold">
Â  Â  Â  Â  <td class="p-2 text-center border-r" colspan="6">Tá»”NG Cá»˜NG</td>
Â  Â  Â  Â  <td class="p-1 border-r text-center"></td>
Â  Â  Â  Â  <td class="p-1 border-r"><input type="text" id="tong_thanhtien_bangdgts" name="tong_thanhtien_bangdgts" readonly class="table-input text-sm bg-transparent border-none text-right font-bold p-1"></td>
Â  Â  Â  Â  <td class="p-1 border-r"><input type="text" id="tong_thanhtienlamtron_bangdgts" name="tong_thanhtienlamtron_bangdgts" readonly class="table-input text-sm bg-transparent border-none text-right font-bold p-1"></td>
Â  Â  Â  Â  <td class="p-1 border-r"><input type="text" id="tong_mucctdtoida_bangdgts" name="tong_mucctdtoida_bangdgts" readonly class="table-input text-sm bg-transparent border-none text-right font-bold p-1"></td>
Â  Â  Â  Â  <td class="p-1 border-r"><input type="text" id="tong_tyleBOA_bangdgts" name="tong_tyleBOA_bangdgts" readonly class="table-input text-sm bg-transparent border-none text-right font-bold p-1"></td>
Â  Â  Â  Â  <td class="p-2 text-center"></td>
Â  Â  Â  </tr>
Â  Â  `;
Â  Â  table.appendChild(tfoot);
Â  }
Â  wrap.appendChild(table);
Â  cont.appendChild(wrap);
Â  const btnC=document.createElement('div');
Â  btnC.className='mt-6 pt-4 border-t flex justify-end';
Â  const add=document.createElement('button');
Â  add.type='button';
Â  add.textContent='â• ThÃªm dÃ²ng má»›i';
Â  add.className='py-2 px-4 bg-amber-600 text-white rounded-lg classic';
Â  add.onclick=()=>addRow(name);
Â  btnC.appendChild(add);
Â  cont.appendChild(btnC);
Â  if (name === '11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') {
Â  Â  cont.appendChild(createTotalSummaryContainer(name, conf));
Â  }
Â  setTimeout(()=>addRow(name,true),0);
Â  return cont;
}

function getTabInfo(n){
Â  const m=n.match(/TÃ i sáº£n báº£o Ä‘áº£m (\d) \((Thá»­a Ä‘áº¥t|NhÃ  á»Ÿ)\)/);
Â  if(!m) return null;
Â  return{index:+m[1],type:m[2]==='Thá»­a Ä‘áº¥t'?'dat':'nha',groupName:m[2]};
}

function updateTotalRow(){
Â  const tab='11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡';
Â  const rows=document.querySelectorAll(`#${CSS.escape(tab)} .table-body tr`);
Â  let totalThanhTien=0;
Â  let totalThanhTienLamTron=0;
Â  let totalMucCTDToiDa=0;

Â  rows.forEach(r=>{
Â  Â  const ttEl=r.querySelector('input[name="thanhtien_bangdgts"]');
Â  Â  const ttltEl=r.querySelector('input[name="thanhtienlamtron_bangdgts"]');
Â  Â  const mctdEl=r.querySelector('input[name="mucctdtoida_bangdgts"]');

Â  Â  totalThanhTien+=parseVN(ttEl?.value);
Â  Â  totalThanhTienLamTron+=parseVN(ttltEl?.value);
Â  Â  totalMucCTDToiDa+=parseVN(mctdEl?.value);
Â  });

Â  const t_tt=$('#tong_thanhtien_bangdgts');
Â  const t_ttlt=$('#tong_thanhtienlamtron_bangdgts');
Â  const t_mctd=$('#tong_mucctdtoida_bangdgts');
Â  const t_boa=$('#tong_tyleBOA_bangdgts');
Â  const t_bangso=$('#tonggiatri_tsbd_bangso');
Â  const t_bangchu=$('#tonggiatri_tsbd_bangchu');

Â  if(t_tt)t_tt.value=totalThanhTien?numFmt(String(totalThanhTien)):'';
Â  if(t_ttlt)t_ttlt.value=totalThanhTienLamTron?numFmt(String(totalThanhTienLamTron)):'';
Â  if(t_mctd)t_mctd.value=totalMucCTDToiDa?numFmt(String(totalMucCTDToiDa)):'';
Â  let totalBOA=0;
Â  if(totalThanhTienLamTron>0){
Â  Â  totalBOA=(totalMucCTDToiDa/totalThanhTienLamTron)*100;
Â  }
Â  if(t_boa)t_boa.value=isFinite(totalBOA)?(Math.round(totalBOA*100)/100).toFixed(2).replace('.',',')+' %':'';

Â  if(t_bangso){
Â  Â  t_bangso.value=t_ttlt.value;Â 
Â  Â  t_bangso.setAttribute('data-raw',totalThanhTienLamTron);Â 
Â  }
Â  if(t_bangchu)t_bangchu.value=toWords(totalThanhTienLamTron);
}

function attachRowCalc(row,cfg){
Â  const get=(n)=>row.querySelector(`input[name="${n}"]`);
Â  const a=get('dientich_bangdgts'),b=get('dongia_bangdgts'),c=get('clcl_bangdgts'),tt=get('thanhtien_bangdgts'),ttlt=get('thanhtienlamtron_bangdgts'),m=get('mucctdtoida_bangdgts'),ty=get('tyleboa_bangdgts');
Â  function compute(){
Â  Â  const dient=parseVN(a?.value),dong=parseVN(b?.value),cl=parseVN(c?.value)/100;
Â  Â  let thanhtien=Math.round(dient*dong*cl);
Â  Â  tt.value=thanhtien?numFmt(String(thanhtien)):'';
Â  Â  const lamtron=thanhtien?Math.floor(thanhtien/1e6)*1e6:0;
Â  Â  ttlt.value=lamtron?numFmt(String(lamtron)):'';
Â  Â  const muc=parseVN(m?.value);
Â  Â  let tyle=lamtron?((muc/lamtron)*100):0;
Â  Â  ty.value=isFinite(tyle)?(Math.round(tyle*100)/100).toFixed(2).replace('.',',')+' %':'';
Â  Â  updateTotalRow();
Â  }
Â  [a,b,c,m].forEach(i=>{
Â  Â  if(i) i.addEventListener('input',()=>setTimeout(compute,0));
Â  Â  if(i) i.addEventListener('blur',()=>setTimeout(compute,0));
Â  });
Â  compute();
}

function generateForm(){
Â  const menu=$('#tabMenu');
Â  const content=$('#tabContent');
  const tabsWithClearButton = [
      "1. ThÃ´ng tin chung", "2. BÃªn nháº­n báº£o Ä‘áº£m", "3. BÃªn báº£o Ä‘áº£m",
      "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡", "11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡", "12. Há»£p Ä‘á»“ng báº£o Ä‘áº£m"
  ];
Â  Object.keys(FIELDS).forEach((name,i)=>{
Â  Â  const cfg=FIELDS[name];
Â  Â  const btn=document.createElement('button');
Â  Â  btn.textContent=name;
Â  Â  btn.className='py-2 px-4 text-sm font-semibold bg-stone-200 border-2 text-amber-900 tabbtn';
Â  Â  btn.onclick=(e)=>openTab(e,name);
Â  Â  menu.appendChild(btn);
Â  Â  let node;
Â  Â  if(cfg.isTable){
Â  Â  Â  node=renderTable(name,cfg);
Â  Â  }else{
Â  Â  Â  node=document.createElement('div');
Â  Â  Â  node.id=name;
Â  Â  Â  node.className='tab-content';
Â  Â  Â  node.style.display='none';
Â  Â  Â  cfg.forEach(f=>node.appendChild(createField(f)));
Â  Â  Â  if (name === "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡") {
Â  Â  Â  Â  const tableNode = renderTable(MERGED_LAND_PRICE_TAB_ID, LAND_PRICE_TABLE_CONFIG);
Â  Â  Â  Â  tableNode.id = MERGED_LAND_PRICE_TAB_ID;
Â  Â  Â  Â  tableNode.style.display = 'block';
Â  Â  Â  Â  tableNode.classList.remove('tab-content');
Â  Â  Â  Â  const header = document.createElement('h2');
Â  Â  Â  Â  header.className = 'text-xl font-bold text-amber-900 mt-6 mb-3 border-b pb-2';
Â  Â  Â  Â  header.textContent = 'Báº£ng Khung giÃ¡ Ä‘áº¥t';
Â  Â  Â  Â  node.appendChild(header);
Â  Â  Â  Â  node.appendChild(tableNode);
Â  Â  Â  }
Â  Â  }
Â  Â  const info=getTabInfo(name);
    if(info || tabsWithClearButton.includes(name)){
      const container = (node.id === '11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') ? node.querySelector('.mt-6.pt-4.border-t') : node;
Â  Â  Â  const ac=document.createElement('div');
Â  Â  Â  ac.className='mt-4 pt-4 border-t flex flex-wrap justify-end gap-3';
      
      if(info){
  Â  Â  Â  const c=document.createElement('button');
  Â  Â  Â  c.type='button';
  Â  Â  Â  c.textContent=`ğŸ“‹ Sao chÃ©p ${info.groupName}`;
  Â  Â  Â  c.className='py-2 px-3 bg-blue-600 text-white rounded-lg classic';
  Â  Â  Â  c.onclick=()=>copyTabGroupData(info.type,name);
  Â  Â  Â  ac.appendChild(c);
  Â  Â  Â  const p=document.createElement('button');
  Â  Â  Â  p.type='button';
  Â  Â  Â  p.textContent=`â¬‡ï¸ DÃ¡n vÃ o ${info.groupName}`;
  Â  Â  Â  p.className='py-2 px-3 bg-blue-400 text-white rounded-lg classic';
  Â  Â  Â  p.onclick=()=>pasteTabGroupData(info.type,name);
  Â  Â  Â  ac.appendChild(p);
      }

Â  Â  Â  const clr=document.createElement('button');
Â  Â  Â  clr.type='button';
Â  Â  Â  clr.textContent='ğŸ—‘ï¸ XÃ³a Tab nÃ y';
Â  Â  Â  clr.className='py-2 px-3 bg-red-400 text-white rounded-lg classic';
Â  Â  Â  clr.onclick=()=>clearTabGroupData(name);
Â  Â  Â  ac.appendChild(clr);
      if (cfg.isTable && container.lastChild) {
        container.insertBefore(ac, container.lastChild);
      } else {
        container.appendChild(ac);
      }
Â  Â  }
Â  Â  content.appendChild(node);
Â  });
Â  if(Object.keys(FIELDS).length)openTab(null,Object.keys(FIELDS)[0]);
}

function copyTabGroupData(type, sourceTabName) {
  const cfg = FIELDS[sourceTabName];
  if (!cfg || cfg.isTable) return;

  const dataToCopy = {};
  cfg.forEach(f => {
      const el = document.getElementById(f.id);
      if (el) {
          dataToCopy[f.genericId] = el.value;
      }
  });

  copied[type] = dataToCopy;
  show(`ÄÃ£ sao chÃ©p dá»¯ liá»‡u ${type === 'dat' ? 'Thá»­a Ä‘áº¥t' : 'NhÃ  á»Ÿ'} vÃ o bá»™ nhá»›.`, 'success');
}

function pasteTabGroupData(type, targetTabName) {
  const dataToPaste = copied[type];
  if (!dataToPaste) {
      show(`ChÆ°a cÃ³ dá»¯ liá»‡u ${type === 'dat' ? 'Thá»­a Ä‘áº¥t' : 'NhÃ  á»Ÿ'} Ä‘á»ƒ dÃ¡n. HÃ£y sao chÃ©p trÆ°á»›c.`, 'error');
      return;
  }

  const cfg = FIELDS[targetTabName];
  if (!cfg || cfg.isTable) return;

  cfg.forEach(f => {
      const value = dataToPaste[f.genericId];
      if (value !== undefined) {
          const el = document.getElementById(f.id);
          if (el) el.value = value;
      }
  });
  show(`ÄÃ£ dÃ¡n dá»¯ liá»‡u ${type === 'dat' ? 'Thá»­a Ä‘áº¥t' : 'NhÃ  á»Ÿ'} thÃ nh cÃ´ng.`, 'success');
}

function clearTabGroupData(tabName) {
Â  const cfg = FIELDS[tabName];
  if (!cfg) return;

  if (cfg.isTable) {
      const tbody = document.querySelector(`#${CSS.escape(tabName)} .table-body`);
      if (tbody) tbody.innerHTML = '';
      addRow(tabName, true);
      updateTotalRow();
  } else {
      if (tabName === "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡") {
          const tableBody = document.querySelector(`#${CSS.escape(MERGED_LAND_PRICE_TAB_ID)} .table-body`);
          if(tableBody) tableBody.innerHTML = '';
          addRow(MERGED_LAND_PRICE_TAB_ID, true);
      }
      cfg.forEach(f => {
    Â  Â  Â  const el = document.getElementById(f.id);
    Â  Â  Â  if (el) el.value = '';
    Â  });
  }

Â  show(`ÄÃ£ xÃ³a sáº¡ch dá»¯ liá»‡u trong tab ${tabName}.`, 'success');
}
function addRow(tab,isInit=false){
Â  const cfg=getTableConfig(tab);
Â  if(!cfg||!cfg.isTable) return;
Â Â 
Â  const tbody=document.querySelector(`#${CSS.escape(tab)} .table-body`);
Â  if(!tbody) return;
Â  rowIdx++;
Â  const tr=document.createElement('tr');
Â  tr.id='r'+rowIdx;
Â  tr.className='border-b hover:bg-amber-50';
Â  cfg.fields.forEach(f=>{
Â  Â  const td=document.createElement('td');
Â  Â  if(f.id.startsWith('stt')){
Â  Â  Â  td.className='p-2 font-bold text-center';
Â  Â  Â  td.innerHTML='<span class="stt"></span>';
Â  Â  }else{
Â  Â  Â  td.className='p-1';
Â  Â  Â  const inp=document.createElement('input');
Â  Â  Â  inp.type='text';
Â  Â  Â  inp.name=f.id;
Â  Â  Â  inp.className='table-input text-sm';
Â  Â  Â  if(f.readonly) {
Â  Â  Â  Â  inp.readOnly=true;
Â  Â  Â  Â  inp.classList.add('bg-stone-100');
Â  Â  Â  }
Â  Â  Â  if(f.type==='currency-integer-table'){
Â  Â  Â  Â  inp.oninput=()=>{ let v=inp.value.replace(/\D/g,''); inp.value=v?numFmt(v):''; };
Â  Â  Â  Â  inp.style.textAlign='right';
Â  Â  Â  }
Â  Â  Â  if(f.type==='currency-decimal-table'){
Â  Â  Â  Â  inp.oninput=()=>{ inp.value=numFmtDecimal(inp.value); };
Â  Â  Â  Â  inp.style.textAlign='right';
Â  Â  Â  }
Â  Â  Â  if(f.type==='percent-integer-table'){
Â  Â  Â  Â  inp.oninput=()=>{
Â  Â  Â  Â  Â  let v=inp.value.replace(/[^0-9]/g,'');
Â  Â  Â  Â  Â  if(v){ let num=parseInt(v); if(num>100) num=100; inp.value=num; }
          else{ inp.value=''; }
Â  Â  Â  Â  };
Â  Â  Â  Â  inp.style.textAlign='right';
Â  Â  Â  Â  if(!f.readonly){
Â  Â  Â  Â  Â  inp.addEventListener('blur',function(){ if(this.value!=='') this.value=this.value+'%'; });
Â  Â  Â  Â  Â  inp.addEventListener('focus',function(){ this.value=this.value.replace(/%/g,''); });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  if(f.type==='percent-decimal-table'){
Â  Â  Â  Â  inp.oninput=()=>{
Â  Â  Â  Â  Â  let v=inp.value.replace(/[^0-9,]/g,'');
Â  Â  Â  Â  Â  const parts=v.split(',');
Â  Â  Â  Â  Â  if(parts.length>2) v=parts[0]+','+parts.slice(1).join('');
Â  Â  Â  Â  Â  inp.value=v;
Â  Â  Â  Â  };
Â  Â  Â  Â  inp.style.textAlign='right';
Â  Â  Â  Â  if(!f.readonly){
Â  Â  Â  Â  Â  inp.addEventListener('blur',function(){
Â  Â  Â  Â  Â  Â  let raw=this.value.replace(/%/g,'').replace(/,/g,'.');
Â  Â  Â  Â  Â  Â  if(raw!==''){
Â  Â  Â  Â  Â  Â  Â  let num=parseFloat(raw);
Â  Â  Â  Â  Â  Â  Â  if(isNaN(num)) num=0;
Â  Â  Â  Â  Â  Â  Â  if(num>100) num=100;
Â  Â  Â  Â  Â  Â  Â  this.value=(Math.round(num*100)/100).toFixed(2).replace('.',',')+' %';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  inp.addEventListener('focus',function(){ this.value=this.value.replace(/\s?%/g,''); });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  td.appendChild(inp);
Â  Â  }
Â  Â  tr.appendChild(td);
Â  });
Â  const del=document.createElement('td');
Â  del.className='p-2 text-center w-[50px]';
Â  const db=document.createElement('button');
Â  db.type='button';
Â  db.textContent='âŒ';
Â  db.className='text-red-600 p-1 rounded-full bg-red-100';
Â  db.onclick=()=>{ tr.remove(); updNums(tab); };
Â  del.appendChild(db);
Â  tr.appendChild(del);
Â  tbody.appendChild(tr);
Â  updNums(tab);
Â  if(cfg.dataKey==='bang_giatri_dinhgia') attachRowCalc(tr,cfg);
Â  if(!isInit){
Â  Â  tr.scrollIntoView({behavior:'smooth',block:'end'});
Â  Â  const fi=tr.querySelector('input');
Â  Â  if(fi) fi.focus();
Â  }
}
function updNums(tab){
Â  const cfg=getTableConfig(tab);
Â  if (!cfg) return;
Â  const rows=document.querySelectorAll(`#${CSS.escape(tab)} .table-body tr`);
Â  rows.forEach((r,i)=>{
Â  Â  const s=r.querySelector('.stt');
Â  Â  if(s) s.textContent=i+1;
Â  });
Â  if(tab==='11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') updateTotalRow();
}
function collectData(){
Â  const out={};
Â  Object.keys(FIELDS).forEach(tab=>{
Â  Â  const cfg=FIELDS[tab];
Â  Â  if(cfg.isTable){
Â  Â  Â  const arr=[];
Â  Â  Â  const rows=document.querySelectorAll(`#${CSS.escape(tab)} .table-body tr`);
Â  Â  Â  rows.forEach(r=>{
Â  Â  Â  Â  const obj={};
Â  Â  Â  Â  const stt=r.querySelector('.stt');
Â  Â  Â  Â  const sttId=cfg.fields.find(f=>f.id.startsWith('stt')).id;
Â  Â  Â  Â  obj[sttId]=stt?stt.textContent:'';
Â  Â  Â  Â  r.querySelectorAll('input').forEach(inp=>{
Â  Â  Â  Â  Â  let v=inp.value;
Â  Â  Â  Â  Â  const fd=cfg.fields.find(f=>f.id===inp.name);
Â  Â  Â  Â  Â  if(fd?.type==='currency-integer-table'||fd?.type==='currency-decimal-table') v=String(v).replace(/\./g,'').replace(/,/g,'.');
Â  Â  Â  Â  Â  if(fd?.type==='percent-integer-table'||fd?.type==='percent-decimal-table') v=String(v).replace(/\s?%/g,'').replace(/,/g,'.');
Â  Â  Â  Â  Â  obj[inp.name]=v;
Â  Â  Â  Â  });
Â  Â  Â  Â  const has=Object.keys(obj).some(k=>k!==sttId&&obj[k]);
Â  Â  Â  Â  if(has) arr.push(obj);
Â  Â  Â  });
Â  Â  Â  out[cfg.dataKey]=arr;
Â  Â  Â  if (tab === '11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') {
Â  Â  Â  Â  out['tong_thanhtien_bangdgts'] = parseVN($('#tong_thanhtien_bangdgts')?.value || '').toString();
Â  Â  Â  Â  out['tong_thanhtienlamtron_bangdgts'] = parseVN($('#tong_thanhtienlamtron_bangdgts')?.value || '').toString();
Â  Â  Â  Â  out['tong_mucctdtoida_bangdgts'] = parseVN($('#tong_mucctdtoida_bangdgts')?.value || '').toString();
Â  Â  Â  Â  out['tong_tyleBOA_bangdgts'] = parseVN($('#tong_tyleBOA_bangdgts')?.value.replace(' %', '') || '').toString();
Â  Â  Â  Â  out['tonggiatri_tsbd_bangso'] = parseVN($('#tonggiatri_tsbd_bangso')?.value || '').toString();
Â  Â  Â  Â  out['tonggiatri_tsbd_bangchu'] = $('#tonggiatri_tsbd_bangchu')?.value || '';
Â  Â  Â  }
Â  Â  }else{
Â  Â  Â  cfg.forEach(f=>{
Â  Â  Â  Â  const el=document.getElementById(f.id);
Â  Â  Â  Â  if(el){ let v=el.value; out[f.id]=v; }
Â  Â  Â  });
Â  Â  Â  if (tab === "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡") {
Â  Â  Â  Â  const tableConfig = LAND_PRICE_TABLE_CONFIG;
Â  Â  Â  Â  const arr = [];
Â  Â  Â  Â  const rows = document.querySelectorAll(`#${CSS.escape(MERGED_LAND_PRICE_TAB_ID)} .table-body tr`);
Â  Â  Â  Â  rows.forEach(r => {
Â  Â  Â  Â  Â  const obj = {};
Â  Â  Â  Â  Â  const stt = r.querySelector('.stt');
Â  Â  Â  Â  Â  const sttId = tableConfig.fields.find(f => f.id.startsWith('stt')).id;
Â  Â  Â  Â  Â  obj[sttId] = stt ? stt.textContent : '';
Â  Â  Â  Â  Â  r.querySelectorAll('input').forEach(inp => {
Â  Â  Â  Â  Â  Â  let v = inp.value;
Â  Â  Â  Â  Â  Â  const fd = tableConfig.fields.find(f => f.id === inp.name);
Â  Â  Â  Â  Â  Â  if (fd?.type === 'currency-integer-table' || fd?.type === 'currency-decimal-table') v = String(v).replace(/\./g, '').replace(/,/g, '.');
Â  Â  Â  Â  Â  Â  if (fd?.type === 'percent-integer-table' || fd?.type === 'percent-decimal-table') v = String(v).replace(/\s?%/g,'').replace(/,/g,'.');
Â  Â  Â  Â  Â  Â  obj[inp.name] = v;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const has = Object.keys(obj).some(k => k !== sttId && obj[k]);
Â  Â  Â  Â  Â  if (has) arr.push(obj);
Â  Â  Â  Â  });
Â  Â  Â  Â  out[tableConfig.dataKey] = arr;
Â  Â  Â  }
Â  Â  }
Â  });
Â  return out;
}
function populateForm(data){
Â  Object.keys(FIELDS).forEach(tab=>{
Â  Â  const cfg=FIELDS[tab];
Â  Â  if(cfg.isTable){
Â  Â  Â  const arr=data[cfg.dataKey]||[];
Â  Â  Â  const tb=document.querySelector(`#${CSS.escape(tab)} .table-body`);
Â  Â  Â  if(!tb) return;
Â  Â  Â  tb.innerHTML='';
Â  Â  Â  if(arr.length===0){ addRow(tab,true); return; }
Â  Â  Â  arr.forEach(rd=>{
Â  Â  Â  Â  addRow(tab,true);
Â  Â  Â  Â  const nr=tb.lastElementChild;
Â  Â  Â  Â  cfg.fields.forEach(f=>{
Â  Â  Â  Â  Â  const inp=nr.querySelector(`input[name="${f.id}"]`);
Â  Â  Â  Â  Â  if(inp&&rd[f.id]!==undefined){
Â  Â  Â  Â  Â  Â  let v=rd[f.id];
Â  Â  Â  Â  Â  Â  if(f.type==='currency-integer-table'){ v=String(v).replace(/\D/g,''); v=v?numFmt(v):''; }
            else if(f.type==='currency-decimal-table'){ v = String(v).replace('.', ','); }
            else if(f.type==='percent-integer-table'){
Â  Â  Â  Â  Â  Â  Â  const raw=String(v).replace(/[^0-9]/g,'');
Â  Â  Â  Â  Â  Â  Â  if(raw==='') v='';
Â  Â  Â  Â  Â  Â  Â  else{ let num=parseInt(raw); if(num>100) num=100; v=num+'%'; }
Â  Â  Â  Â  Â  Â  } else if(f.type==='percent-decimal-table'){
Â  Â  Â  Â  Â  Â  Â  const raw=String(v).replace(/,/g,'.').replace(/[^0-9\.]/g,'');
Â  Â  Â  Â  Â  Â  Â  if(raw==='') v='';
Â  Â  Â  Â  Â  Â  Â  else {
                let num=parseFloat(raw);
                if(isNaN(num)) num=0;
                if(num>100) num=100;
                v=(f.id==='tyleboa_bangdgts')?(Math.round(num*100)/100).toFixed(2).replace('.',',')+' %':(Math.round(num*100)/100).toFixed(2).replace('.',',')+'%';
              }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  inp.value=v;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  updNums(tab);
Â  Â  Â  });
Â  Â  Â  if (tab === '11. GiÃ¡ trá»‹ Ä‘á»‹nh giÃ¡') { updateTotalRow(); }
Â  Â  }else{
Â  Â  Â  cfg.forEach(f=>{
Â  Â  Â  Â  const el=document.getElementById(f.id);
Â  Â  Â  Â  if(el&&data[f.id]!==undefined){ el.value=data[f.id]; }
Â  Â  Â  });
Â  Â  Â  if (tab === "10. CÄƒn cá»© Ä‘á»‹nh giÃ¡") {
Â  Â  Â  Â  const tableConfig = LAND_PRICE_TABLE_CONFIG;
Â  Â  Â  Â  const arr = data[tableConfig.dataKey] || [];
Â  Â  Â  Â  const tb = document.querySelector(`#${CSS.escape(MERGED_LAND_PRICE_TAB_ID)} .table-body`);
Â  Â  Â  Â  if(!tb) return;
Â  Â  Â  Â  tb.innerHTML = '';
Â  Â  Â  Â  if(arr.length === 0){ addRow(MERGED_LAND_PRICE_TAB_ID, true); return; }
Â  Â  Â  Â  arr.forEach(rd => {
Â  Â  Â  Â  Â  addRow(MERGED_LAND_PRICE_TAB_ID, true);
Â  Â  Â  Â  Â  const nr = tb.lastElementChild;
Â  Â  Â  Â  Â  tableConfig.fields.forEach(f => {
Â  Â  Â  Â  Â  Â  const inp = nr.querySelector(`input[name="${f.id}"]`);
Â  Â  Â  Â  Â  Â  if(inp && rd[f.id] !== undefined){
Â  Â  Â  Â  Â  Â  Â  let v = rd[f.id];
Â  Â  Â  Â  Â  Â  Â  if(f.type==='currency-integer-table'){ v=String(v).replace(/\D/g,''); v=v?numFmt(v):'';}
              else if(f.type==='currency-decimal-table'){ v = String(v).replace('.', ','); }
              else if(f.type==='percent-integer-table'){
Â  Â  Â  Â  Â  Â  Â  Â  const raw=String(v).replace(/[^0-9]/g,'');
Â  Â  Â  Â  Â  Â  Â  Â  if(raw==='') v=''; else{ let num=parseInt(raw); if(num>100) num=100; v=num+'%';}
Â  Â  Â  Â  Â  Â  Â  } else if(f.type==='percent-decimal-table'){
Â  Â  Â  Â  Â  Â  Â  Â  const raw=String(v).replace(/,/g,'.').replace(/[^0-9\.]/g,'');
Â  Â  Â  Â  Â  Â  Â  Â  if(raw==='') v=''; else{
                  let num=parseFloat(raw); if(isNaN(num)) num=0; if(num>100) num=100;
                  v=(f.id==='tyleboa_bangdgts')?(Math.round(num*100)/100).toFixed(2).replace('.',',')+' %':(Math.round(num*100)/100).toFixed(2).replace('.',',')+'%';
                }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  inp.value = v;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  updNums(MERGED_LAND_PRICE_TAB_ID);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  });
}

$('#loadFileInput').addEventListener('change',e=>{
Â  const f=e.target.files[0];
Â  if(!f) return;
Â  const r=new FileReader();
Â  r.onload=ev=>{
Â  Â  try{
Â  Â  Â  const d=JSON.parse(ev.target.result);
Â  Â  Â  populateForm(d);
Â  Â  Â  show('ÄÃ£ táº£i dá»¯ liá»‡u','success');
Â  Â  Â  updateTotalRow();Â 
Â  Â  }catch(err){ show('Lá»—i JSON','error'); }
Â  };
Â  r.readAsText(f);
});

$('#profileForm').addEventListener('submit',async e=>{
Â  e.preventDefault();
Â  if(!selectedTemplate || !selectedTemplate.blob){
Â  Â  show('Vui lÃ²ng chá»n má»™t loáº¡i há»“ sÆ¡ cáº§n táº¡o tá»« danh sÃ¡ch á»Ÿ trÃªn.','error');
Â  Â  return;
Â  }
Â  const data=collectData();
Â  
Â  const fd=new FormData();
Â  fd.append('template', selectedTemplate.blob, selectedTemplate.path);
Â  fd.append('data',JSON.stringify(data));
Â  show('Äang táº¡o DOCX...','info');
Â  $('#btn-generate').disabled=true;
Â  try{
Â  Â  const resp=await fetch('/generate',{method:'POST',body:fd});
Â  Â  if(!resp.ok)throw new Error(`Lá»—i tá»« server: ${resp.status} ${resp.statusText}`);
Â  Â  const blob=await resp.blob();
Â  Â  const name=`HoSoTSBD_${selectedTemplate.name.replace(/^\d+\.\s/,'')}_${new Date().toISOString().slice(0,10)}.docx`;
Â  Â  const url=URL.createObjectURL(blob);
Â  Â  const a=document.createElement('a');
Â  Â  a.href=url;
Â  Â  a.download=name;
Â  Â  document.body.appendChild(a);
Â  Â  a.click();
Â  Â  a.remove();
Â  Â  URL.revokeObjectURL(url);
Â  Â  show('Táº¡o DOCX thÃ nh cÃ´ng','success');
Â  }catch(err){
Â  Â  show('Lá»—i khi táº¡o DOCX: '+err.message,'error');
Â  }finally{
Â  Â  $('#btn-generate').disabled=false;
Â  }
});
function saveData(){
Â  const d=collectData();
Â  const s=JSON.stringify(d,null,2);
Â  const b=new Blob([s],{type:'application/json'});
Â  const u=URL.createObjectURL(b);
Â  const a=document.createElement('a');
Â  a.href=u;
Â  a.download=`DuLieuHoSoTSBD_${new Date().toISOString().slice(0,10)}.json`;
Â  document.body.appendChild(a);
Â  a.click();
Â  a.remove();
Â  URL.revokeObjectURL(u);
Â  show('ÄÃ£ lÆ°u nhÃ¡p','info');
}

window.onload=()=>{
Â  generateForm();
  generateTemplateButtons();
Â  document.querySelectorAll('.classic').forEach(b=>{
Â  Â  if(!b.style.boxShadow){
Â  Â  Â  b.style.boxShadow='0 4px 0 rgba(0,0,0,.4)';
Â  Â  Â  b.style.borderBottom='2px solid rgba(0,0,0,.4)';
Â  Â  }
Â  });
}
</script>
</body>
</html>

